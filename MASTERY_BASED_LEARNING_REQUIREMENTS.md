# 基于掌握度的学习模式 - 需求文档

## 1. 项目信息

- **项目名称**: Mastery-Based Learning Mode（掌握度驱动学习）
- **版本**: v1.0
- **创建日期**: 2024
- **关联模块**: 学习页面、AMAS引擎、单词调度器

---

## 2. 背景与问题

### 2.1 当前问题

| 问题 | 影响 |
|------|------|
| 用户选择"学10个词"只产生10道题 | AMAS数据点不足，判断不准 |
| 每个单词只练习1次 | 用户可能没真正记住就结束了 |
| 学习目标是"数量"而非"掌握" | 违背学习科学原则 |
| AMAS需要50+数据点才准确 | 每次学10词的用户体验不到智能调整 |

### 2.2 核心洞察

> **用户的真实目标是"记住单词"，而不是"刷题数量"**

---

## 3. 功能需求

### 3.1 核心概念变更

| 原概念 | 新概念 | 说明 |
|--------|--------|------|
| 学习X个单词 | **记住**X个单词 | 目标从"接触"变为"掌握" |
| 每词1题 | 每词N题（动态） | 直到达到掌握标准 |
| 固定题目数 | 动态题目数 | 根据用户表现自动调整 |

### 3.2 掌握标准定义

#### FR-3.2.1 单词掌握判定

**规则**: 单词在**本次学习会话中**达到以下条件之一即视为"记住"：

| 条件 | 说明 | 适用场景 |
|------|------|---------|
| 连续答对2次 | 基础掌握标准 | 新学单词 |
| 首次即答对 + 反应时间<3秒 | 快速正确说明已掌握 | 复习单词 |
| 累计答对3次（允许中间错1次） | 容错机制 | 避免偶然失误 |

**验收标准**:
- [ ] 新词连续答对2次标记为"本次已记住"
- [ ] 复习词首次秒答正确也可标记为"本次已记住"
- [ ] 支持配置掌握标准参数

#### FR-3.2.2 会话掌握 vs 长期掌握

| 类型 | 定义 | 存储 |
|------|------|------|
| **会话掌握** | 本次学习中达到掌握标准 | 仅在会话内有效 |
| **长期掌握** | SRS系统的masteryLevel | 持久化到数据库 |

**说明**: 会话掌握是临时状态，用于控制本次学习流程；长期掌握仍由SRS系统管理。

---

### 3.3 学习流程重设计

#### FR-3.3.1 学习目标设置

**接口变更**:

```typescript
// 旧接口
interface LearningConfig {
  dailyTarget: number;  // 每日学习单词数
}

// 新接口
interface LearningConfig {
  dailyMasteryTarget: number;  // 每日要记住的单词数
  maxQuestionsPerSession?: number;  // 单次会话最大题目数（防无限循环）
}
```

**验收标准**:
- [ ] 前端设置页面文案从"每日学习X词"改为"每日记住X词"
- [ ] 后端支持新的配置字段
- [ ] 默认 maxQuestionsPerSession = 100

#### FR-3.3.2 单词队列管理

**描述**: 实现一个智能单词队列，动态管理待学习单词

```typescript
interface WordQueue {
  /** 待学习的单词池 */
  pendingWords: WordItem[];
  /** 当前正在学习的单词（未达到掌握标准） */
  activeWords: Map<string, WordProgress>;
  /** 本次会话已掌握的单词 */
  masteredWords: Set<string>;
  /** 目标掌握数量 */
  targetCount: number;
}

interface WordProgress {
  wordId: string;
  correctCount: number;      // 本次会话正确次数
  wrongCount: number;        // 本次会话错误次数
  consecutiveCorrect: number; // 连续正确次数
  lastAnswerTime: number;    // 上次答题时间
}
```

**验收标准**:
- [ ] 支持动态添加单词到活跃队列
- [ ] 答对的单词根据掌握标准判断是否移入已掌握
- [ ] 答错的单词重新加入待出题队列
- [ ] 已掌握数量达到目标时结束学习

#### FR-3.3.3 出题策略

**规则**:

```
1. 优先出「活跃队列」中错误次数多的单词（加强薄弱点）
2. 当活跃队列较空时，从待学习池补充新单词
3. 同一单词两次出现间隔至少2题（间隔效应）
4. 控制活跃队列大小在3-8个之间（认知负荷）
```

**验收标准**:
- [ ] 错误单词优先复现
- [ ] 相同单词不连续出现
- [ ] 活跃队列维持合理大小

---

### 3.4 前端交互变更

#### FR-3.4.1 学习页面进度显示

**当前**: `3/10` (第3题/共10题)

**新设计**: 
```
已记住: 2/10 词  |  本次答题: 15题
```

**验收标准**:
- [ ] 显示已掌握单词数/目标数
- [ ] 显示本次总答题数
- [ ] 进度条按掌握数计算，而非题目数

#### FR-3.4.2 单词卡片状态指示

**新增状态指示**:

| 状态 | 显示 | 说明 |
|------|------|------|
| 首次见面 | 🆕 新词 | 第一次出现 |
| 学习中 | 🔄 再练 | 还未达到掌握标准 |
| 即将掌握 | ⭐ 加油 | 再对1次就记住了 |
| 已掌握 | ✅ 记住了 | 达到掌握标准 |

#### FR-3.4.3 学习完成页面

**新增统计**:

```
🎉 太棒了！

本次学习成果：
├── 记住了 10 个单词
├── 共答题 32 题
├── 正确率 78%
├── 用时 12 分钟
└── 平均每词 3.2 次达到掌握

AMAS 分析：
├── 注意力评分: 85%
├── 疲劳程度: 低
└── 建议: 状态很好，可以继续学习！
```

---

### 3.5 与AMAS集成

#### FR-3.5.1 数据上报增强

**每次答题仍然上报AMAS**，新增字段：

```typescript
interface AMASEventExtended {
  // 现有字段...
  wordId: string;
  isCorrect: boolean;
  responseTime: number;
  
  // 新增字段
  sessionWordProgress?: {
    correctCount: number;
    wrongCount: number;
    isNewWord: boolean;
  };
}
```

#### FR-3.5.2 AMAS策略应用

**AMAS返回的策略如何影响新模式**:

| AMAS建议 | 在新模式中的作用 |
|----------|------------------|
| 降低难度 | 减少活跃队列大小，增加提示 |
| 建议休息 | 弹窗提醒，但不强制结束 |
| 调整间隔 | 影响单词重复出现的间隔 |

---

## 4. 非功能需求

### 4.1 性能要求

| 指标 | 要求 |
|------|------|
| 出题响应时间 | < 100ms |
| 队列操作 | < 10ms |
| 内存占用 | 队列最多缓存50个单词状态 |

### 4.2 用户体验

- 学习过程流畅，无感知卡顿
- 进度反馈及时准确
- 支持中途退出保存进度

### 4.3 兼容性

- 新老用户平滑过渡
- 旧配置自动转换为新配置
- 支持回退到旧模式（配置开关）

---

## 5. 数据模型变更

### 5.1 用户配置表扩展

```prisma
model UserStudyConfig {
  // 现有字段...
  
  // 新增字段
  learningMode       String   @default("mastery")  // "mastery" | "quantity"
  dailyMasteryTarget Int      @default(20)
  masteryThreshold   Int      @default(2)  // 连续正确次数
}
```

### 5.2 学习会话表扩展

```prisma
model LearningSession {
  // 现有字段...
  
  // 新增字段
  targetMasteryCount  Int?      // 目标掌握数
  actualMasteryCount  Int?      // 实际掌握数
  totalQuestions      Int?      // 总答题数
}
```

---

## 6. 接口变更

### 6.1 获取学习单词接口

**当前**: `GET /api/words/study?count=10`

**新接口**: `GET /api/words/study?masteryTarget=10&mode=mastery`

**响应变更**:
```json
{
  "words": [...],
  "meta": {
    "mode": "mastery",
    "masteryTarget": 10,
    "maxQuestions": 100,
    "masteryThreshold": 2
  }
}
```

### 6.2 学习进度同步接口（新增）

`POST /api/learning/progress`

```json
{
  "sessionId": "xxx",
  "wordProgress": {
    "word-1": { "correct": 2, "wrong": 0, "mastered": true },
    "word-2": { "correct": 1, "wrong": 1, "mastered": false }
  },
  "totalQuestions": 15,
  "masteredCount": 5
}
```

---

## 7. 实现优先级

### P0 - MVP（必须）

- [ ] FR-3.2.1 单词掌握判定逻辑
- [ ] FR-3.3.2 单词队列管理
- [ ] FR-3.3.3 出题策略
- [ ] FR-3.4.1 学习页面进度显示

### P1 - 重要（应该）

- [ ] FR-3.3.1 学习目标设置
- [ ] FR-3.4.2 单词卡片状态指示
- [ ] FR-3.4.3 学习完成页面增强
- [ ] FR-3.5.1 AMAS数据上报增强

### P2 - 增强（可以）

- [ ] FR-3.5.2 AMAS策略深度应用
- [ ] 学习模式切换（mastery/quantity）
- [ ] 掌握标准个性化配置

---

## 8. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 用户觉得题目太多 | 流失 | 设置最大题目数限制，进度可视化 |
| 某个词一直记不住 | 卡死 | 错误3次后降级处理，给提示 |
| 学习时间过长 | 疲劳 | AMAS检测+主动提醒休息 |

---

## 9. 测试要点

### 9.1 功能测试

- 掌握判定逻辑正确性
- 队列管理边界情况
- 进度计算准确性

### 9.2 集成测试

- 与AMAS系统的数据流
- 与SRS系统的状态同步
- 前后端数据一致性

### 9.3 用户测试

- A/B测试新旧模式的完成率
- 用户满意度调查
- 实际掌握效果对比（次日留存测试）

---

## 10. 里程碑

| 阶段 | 内容 | 预估时间 |
|------|------|---------|
| M1 | 后端队列逻辑 + 掌握判定 | 2天 |
| M2 | 前端学习页面改造 | 2天 |
| M3 | AMAS集成 + 数据统计 | 1天 |
| M4 | 设置页面 + 完成页面 | 1天 |
| M5 | 测试 + 优化 | 2天 |

**总计**: 约 8 个工作日
