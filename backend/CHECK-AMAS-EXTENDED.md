# AMASæ‰©å±•ç‰ˆæ£€æŸ¥æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä½¿ç”¨è¯Šæ–­è„šæœ¬æ£€æŸ¥AMASæ‰©å±•ç‰ˆçš„è¿è¡ŒçŠ¶æ€ã€‚

---

## ğŸ“¦ å¯ç”¨çš„æ£€æŸ¥è„šæœ¬

### 1ï¸âƒ£  ç»¼åˆè¯Šæ–­ï¼ˆæ¨èé¦–é€‰ï¼‰

**è„šæœ¬**: `diagnose-amas-extended.js`

**åŠŸèƒ½**: ä¸€é”®æ£€æŸ¥æ‰€æœ‰æ‰©å±•ç‰ˆåŠŸèƒ½ï¼Œè¾“å‡ºç»¼åˆè¯Šæ–­æŠ¥å‘Š

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd backend
node diagnose-amas-extended.js
```

**æ£€æŸ¥å†…å®¹**:
- âœ… æ•°æ®åº“è¿æ¥
- âœ… æ‰©å±•ç‰ˆæ•°æ®è¡¨ï¼ˆ4å¼ æ–°è¡¨ï¼‰
- âœ… ç‰¹å¾å‘é‡ï¼ˆæ˜¯å¦ä¸º22ç»´ï¼‰
- âœ… å»¶è¿Ÿå¥–åŠ±Workerè¿è¡ŒçŠ¶æ€
- âœ… ä¹ æƒ¯ç”»åƒæ•°æ®
- âœ… å­¦ä¹ ä¼šè¯æ•°æ®

**è¾“å‡ºç¤ºä¾‹**:
```
========================================
ğŸ”¬ AMASæ‰©å±•ç‰ˆç»¼åˆè¯Šæ–­
========================================

1ï¸âƒ£  æ•°æ®åº“è¿æ¥æ£€æŸ¥...
   âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ

2ï¸âƒ£  æ‰©å±•ç‰ˆæ•°æ®è¡¨æ£€æŸ¥...
   âœ… learning_sessions è¡¨å­˜åœ¨
   âœ… feature_vectors è¡¨å­˜åœ¨
   âœ… habit_profiles è¡¨å­˜åœ¨
   âœ… reward_queue è¡¨å­˜åœ¨
   âœ… æ‰€æœ‰æ‰©å±•ç‰ˆæ•°æ®è¡¨å·²åˆ›å»º

3ï¸âƒ£  ç‰¹å¾å‘é‡æ£€æŸ¥...
   ğŸ“Š æ€»æ•°: 156
   ğŸ“ˆ v1 (12ç»´): 120
   ğŸ“ˆ v2 (22ç»´): 36
   ğŸ” æœ€æ–°ç‰¹å¾å‘é‡: v2, å®é™…ç»´åº¦: 22
   âœ… æ‰©å±•ç‰ˆï¼ˆ22ç»´ï¼‰ç‰¹å¾å‘é‡å·²ç”Ÿæ•ˆ

...
```

---

### 2ï¸âƒ£  ç‰¹å¾å‘é‡è¯¦ç»†æ£€æŸ¥

**è„šæœ¬**: `check-feature-vectors.js`

**åŠŸèƒ½**: è¯¦ç»†æ£€æŸ¥ç‰¹å¾å‘é‡çš„å­˜å‚¨æ ¼å¼å’Œç»´åº¦

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd backend
node check-feature-vectors.js
```

**æ£€æŸ¥å†…å®¹**:
- ç‰¹å¾å‘é‡æ€»æ•°å’Œç‰ˆæœ¬åˆ†å¸ƒ
- æœ€æ–°10æ¡ç‰¹å¾å‘é‡çš„è¯¦ç»†ä¿¡æ¯
- ç‰¹å¾å‘é‡æ ¼å¼ï¼ˆæ•°ç»„æ ¼å¼ vs å¯¹è±¡æ ¼å¼ï¼‰
- å®é™…ç»´åº¦éªŒè¯
- å…³è”å­¦ä¹ ä¼šè¯æ£€æŸ¥

**é€‚ç”¨åœºæ™¯**:
- éœ€è¦ç¡®è®¤ç‰¹å¾å‘é‡æ˜¯å¦æ­£ç¡®ä¿å­˜ä¸º22ç»´
- æ’æŸ¥ç‰¹å¾å‘é‡æ ¼å¼é—®é¢˜
- æŸ¥çœ‹ç‰¹å¾å‘é‡çš„è¯¦ç»†æ•°æ®

---

### 3ï¸âƒ£  å»¶è¿Ÿå¥–åŠ±Workeræ£€æŸ¥

**è„šæœ¬**: `check-delayed-reward.js`

**åŠŸèƒ½**: è¯¦ç»†æ£€æŸ¥å»¶è¿Ÿå¥–åŠ±æœºåˆ¶çš„è¿è¡ŒçŠ¶æ€

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd backend
node check-delayed-reward.js
```

**æ£€æŸ¥å†…å®¹**:
- å¥–åŠ±é˜Ÿåˆ—çŠ¶æ€åˆ†å¸ƒï¼ˆPENDING/PROCESSING/DONE/FAILEDï¼‰
- å¾…å¤„ç†å’Œå·²åˆ°æœŸä»»åŠ¡æ•°é‡
- æœ€è¿‘10ä¸ªä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯
- Workerè¿è¡ŒçŠ¶æ€æ¨æ–­
- å¤„ç†æ•ˆç‡ç»Ÿè®¡
- å¹‚ç­‰æ€§éªŒè¯

**é€‚ç”¨åœºæ™¯**:
- éœ€è¦ç¡®è®¤å»¶è¿Ÿå¥–åŠ±Workeræ˜¯å¦æ­£åœ¨è¿è¡Œ
- æ’æŸ¥å»¶è¿Ÿå¥–åŠ±ä»»åŠ¡å¤„ç†å¤±è´¥çš„åŸå› 
- æŸ¥çœ‹å»¶è¿Ÿå¥–åŠ±å¤„ç†æ•ˆç‡

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: è¿è¡Œç»¼åˆè¯Šæ–­

```bash
cd backend
node diagnose-amas-extended.js
```

æ ¹æ®è¯Šæ–­ç»“æœåˆ¤æ–­ç³»ç»ŸçŠ¶æ€ï¼š

**æƒ…å†µA: æ‰€æœ‰æ£€æŸ¥é€šè¿‡** âœ…
```
âœ… AMASæ‰©å±•ç‰ˆè¿è¡ŒçŠ¶æ€ï¼šä¼˜ç§€
   æ‰€æœ‰ç»„ä»¶å‡æ­£å¸¸å·¥ä½œ
```
ğŸ‘‰ æ‰©å±•ç‰ˆå·²æˆåŠŸä¸Šçº¿ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨

---

**æƒ…å†µB: æœ‰è­¦å‘Šä¿¡æ¯** âš ï¸
```
âš ï¸  AMASæ‰©å±•ç‰ˆè¿è¡ŒçŠ¶æ€ï¼šéœ€è¦å…³æ³¨
âš ï¸  éœ€è¦å…³æ³¨çš„é¡¹ç›®:
   - featureVectors: æ— æ•°æ®
   - delayedReward: é˜Ÿåˆ—ä¸ºç©º
```
ğŸ‘‰ ä»£ç å·²éƒ¨ç½²ï¼Œä½†å°šæœªäº§ç”Ÿæ•°æ®ï¼Œéœ€è¦è¿›è¡Œå­¦ä¹ æ´»åŠ¨

**è§£å†³æ–¹æ³•**:
```bash
# 1. ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ
cd backend
npm run dev

# 2. åœ¨å‰ç«¯è¿›è¡Œå­¦ä¹ æ´»åŠ¨ï¼Œç”Ÿæˆæ•°æ®
# ç„¶åé‡æ–°è¿è¡Œè¯Šæ–­è„šæœ¬
node diagnose-amas-extended.js
```

---

**æƒ…å†µC: æœ‰é”™è¯¯ä¿¡æ¯** âŒ
```
âŒ AMASæ‰©å±•ç‰ˆè¿è¡ŒçŠ¶æ€ï¼šå­˜åœ¨é—®é¢˜
âš ï¸  å‘ç°çš„é—®é¢˜:
   - database: learning_sessionsè¡¨ç¼ºå¤±
```
ğŸ‘‰ æ•°æ®åº“è¿ç§»æœªå®Œæˆæˆ–å¤±è´¥

**è§£å†³æ–¹æ³•**:
```bash
# 1. æ£€æŸ¥æ•°æ®åº“è¿ç§»çŠ¶æ€
cd backend
npx prisma migrate status

# 2. å¦‚æœæœ‰æœªåº”ç”¨çš„è¿ç§»ï¼Œè¿è¡Œ:
npx prisma migrate deploy

# 3. é‡æ–°ç”ŸæˆPrismaå®¢æˆ·ç«¯
npx prisma generate

# 4. é‡æ–°è¿è¡Œè¯Šæ–­
node diagnose-amas-extended.js
```

---

### æ­¥éª¤2: è¯¦ç»†æ£€æŸ¥ç‰¹å¾å‘é‡

```bash
cd backend
node check-feature-vectors.js
```

**å…³é”®æŒ‡æ ‡**:
- ç¡®è®¤æœ€æ–°ç‰¹å¾å‘é‡ä¸º **v2, 22ç»´** âœ…
- æ•°æ®æ ¼å¼ä¸º **å¯¹è±¡æ ¼å¼ {values, labels, ts}** âœ…

**æ­£å¸¸è¾“å‡ºç¤ºä¾‹**:
```
1. âœ… sessionId: abc12345...
   ç‰ˆæœ¬: v2 | ç»´åº¦: 22 | æ ¼å¼: å¯¹è±¡æ ¼å¼ {values, labels, ts}
   æ•°æ®é¢„è§ˆ: [0.750, 0.150, 0.100...]
   åˆ›å»ºæ—¶é—´: 2025-11-24T12:30:00.000Z
```

---

### æ­¥éª¤3: éªŒè¯å»¶è¿Ÿå¥–åŠ±Worker

```bash
cd backend
node check-delayed-reward.js
```

**å…³é”®æŒ‡æ ‡**:
- WorkerçŠ¶æ€: **æ­£åœ¨æ­£å¸¸è¿è¡Œ** âœ…
- æœ€è¿‘5åˆ†é’Ÿå®Œæˆçš„ä»»åŠ¡: **> 0** âœ…
- å·²åˆ°æœŸä½†æœªå¤„ç†çš„ä»»åŠ¡: **0** âœ…

**æ­£å¸¸è¾“å‡ºç¤ºä¾‹**:
```
æœ€è¿‘5åˆ†é’Ÿå®Œæˆçš„ä»»åŠ¡: 3 ä¸ª
âœ… Workeræ­£åœ¨æ­£å¸¸è¿è¡Œ
   æœ€è¿‘5åˆ†é’Ÿå·²å¤„ç† 3 ä¸ªä»»åŠ¡
```

**å¼‚å¸¸è¾“å‡ºç¤ºä¾‹**:
```
æœ‰ 5 ä¸ªä»»åŠ¡å·²åˆ°æœŸä½†æœªå¤„ç†
âš ï¸  Workerå¯èƒ½æœªè¿è¡Œæˆ–å¤„ç†ç¼“æ…¢
å»ºè®®æ£€æŸ¥:
1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨
2. æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "Delayed reward worker started"
3. æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰Workeré”™è¯¯ä¿¡æ¯
```

**è§£å†³æ–¹æ³•**:
```bash
# 1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
ps aux | grep "src/index.ts"

# 2. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
# åº”è¯¥çœ‹åˆ°:
#   - "Database connected successfully"
#   - "Delayed reward worker started"
#   - "Server running on http://localhost:3001"

# 3. å¦‚æœæœåŠ¡æœªè¿è¡Œï¼Œå¯åŠ¨æœåŠ¡:
cd backend
npm run dev
```

---

## ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: ç‰¹å¾å‘é‡ç»´åº¦ä»ä¸º12ç»´

**ç°è±¡**:
```
âš ï¸  å½“å‰ä»ä½¿ç”¨MVPç‰ˆï¼ˆ12ç»´ï¼‰ï¼Œæ‰©å±•ç‰ˆæœªæ¿€æ´»
```

**åŸå› **: åç«¯æœåŠ¡ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬ä»£ç ï¼Œæˆ–ç¼“å­˜äº†æ—§çš„LinUCBæ¨¡å‹

**è§£å†³æ–¹æ³•**:
```bash
# 1. ç¡®è®¤ä»£ç å·²æ›´æ–°åˆ°æ‰©å±•ç‰ˆ
cd backend/src/amas/config
cat action-space.ts | grep DEFAULT_DIMENSION
# åº”è¯¥è¾“å‡º: export const DEFAULT_DIMENSION = 22;

# 2. é‡å¯åç«¯æœåŠ¡
# Ctrl+C åœæ­¢æœåŠ¡ï¼Œç„¶å:
npm run dev

# 3. æ¸…é™¤ç”¨æˆ·çš„AMASçŠ¶æ€ï¼ˆå¯é€‰ï¼Œä»…æµ‹è¯•ç”¨æˆ·ï¼‰
# åœ¨å‰ç«¯æ‰§è¡Œ"é‡ç½®å­¦ä¹ çŠ¶æ€"æ“ä½œ

# 4. è¿›è¡Œæ–°çš„å­¦ä¹ æ´»åŠ¨

# 5. é‡æ–°æ£€æŸ¥
node check-feature-vectors.js
```

---

### é—®é¢˜2: å»¶è¿Ÿå¥–åŠ±Workeræœªè¿è¡Œ

**ç°è±¡**:
```
æœ‰ 10 ä¸ªä»»åŠ¡å·²åˆ°æœŸä½†æœªå¤„ç†
âš ï¸  Workerå¯èƒ½æœªè¿è¡Œ
```

**åŸå› **:
- åç«¯æœåŠ¡æœªå¯åŠ¨
- Workerå¯åŠ¨å¤±è´¥
- Node-cronä¾èµ–ç¼ºå¤±

**è§£å†³æ–¹æ³•**:
```bash
# 1. æ£€æŸ¥node-cronä¾èµ–
cd backend
npm list node-cron
# åº”è¯¥æ˜¾ç¤º: node-cron@3.0.3

# 2. å¦‚æœç¼ºå¤±ï¼Œå®‰è£…ä¾èµ–:
npm install

# 3. æ£€æŸ¥index.tsæ˜¯å¦åŒ…å«Workerå¯åŠ¨ä»£ç 
cat src/index.ts | grep "startDelayedRewardWorker"
# åº”è¯¥æœ‰è°ƒç”¨

# 4. é‡å¯æœåŠ¡å¹¶æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
npm run dev
# åº”è¯¥çœ‹åˆ°: "Delayed reward worker started (æ¯åˆ†é’Ÿæ‰§è¡Œ)"

# 5. ç­‰å¾…1-2åˆ†é’Ÿåé‡æ–°æ£€æŸ¥
node check-delayed-reward.js
```

---

### é—®é¢˜3: æ•°æ®åº“è¡¨ä¸å­˜åœ¨

**ç°è±¡**:
```
âŒ learning_sessions è¡¨ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®
```

**è§£å†³æ–¹æ³•**:
```bash
cd backend

# 1. æ£€æŸ¥è¿ç§»çŠ¶æ€
npx prisma migrate status

# 2. å¦‚æœæ˜¾ç¤º"æœªåº”ç”¨çš„è¿ç§»"ï¼Œè¿è¡Œ:
npx prisma migrate deploy

# 3. é‡æ–°ç”ŸæˆPrismaå®¢æˆ·ç«¯
npx prisma generate

# 4. éªŒè¯è¡¨å·²åˆ›å»º
npx prisma db execute --stdin <<< "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('learning_sessions', 'feature_vectors', 'habit_profiles', 'reward_queue');"

# 5. é‡æ–°è¿è¡Œè¯Šæ–­
node diagnose-amas-extended.js
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§å»ºè®®

### å®šæœŸæ£€æŸ¥ï¼ˆæ¯å¤©ï¼‰
```bash
# å¿«é€Ÿå¥åº·æ£€æŸ¥
cd backend
node diagnose-amas-extended.js | grep "ç»¼åˆè¯Šæ–­ç»“è®º" -A 10
```

### æ·±åº¦æ£€æŸ¥ï¼ˆæ¯å‘¨ï¼‰
```bash
# 1. ç‰¹å¾å‘é‡å®Œæ•´æ£€æŸ¥
node check-feature-vectors.js > feature-vectors-report.txt

# 2. å»¶è¿Ÿå¥–åŠ±å®Œæ•´æ£€æŸ¥
node check-delayed-reward.js > delayed-reward-report.txt

# 3. åˆ†ææŠ¥å‘Šï¼ŒæŸ¥æ‰¾å¼‚å¸¸
```

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœæ£€æŸ¥è„šæœ¬è¾“å‡ºçš„ä¿¡æ¯æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **è¯Šæ–­è¾“å‡º**:
   ```bash
   node diagnose-amas-extended.js > diagnosis.txt
   ```

2. **æœåŠ¡æ—¥å¿—**ï¼ˆæœ€å50è¡Œï¼‰:
   ```bash
   # å¦‚æœä½¿ç”¨pm2
   pm2 logs backend --lines 50

   # å¦‚æœç›´æ¥è¿è¡Œ
   # å¤åˆ¶ç»ˆç«¯è¾“å‡ºçš„æœ€å50è¡Œ
   ```

3. **ç¯å¢ƒä¿¡æ¯**:
   ```bash
   node -v
   npm -v
   npx prisma -v
   ```

4. **æ•°æ®åº“è¿ç§»çŠ¶æ€**:
   ```bash
   npx prisma migrate status
   ```

---

## âœ… éªŒæ”¶æ ‡å‡†

æ‰©å±•ç‰ˆæˆåŠŸä¸Šçº¿çš„æ ‡å¿—ï¼š

- âœ… `node diagnose-amas-extended.js` æ˜¾ç¤º "è¿è¡ŒçŠ¶æ€ï¼šä¼˜ç§€"
- âœ… ç‰¹å¾å‘é‡ç»´åº¦ä¸º **22ç»´**
- âœ… ç‰¹å¾ç‰ˆæœ¬ä¸º **v2**
- âœ… å»¶è¿Ÿå¥–åŠ±Worker **æ­£åœ¨è¿è¡Œ**
- âœ… æœ€è¿‘5åˆ†é’Ÿå†…æœ‰ä»»åŠ¡è¢«å¤„ç†
- âœ… æ— å·²åˆ°æœŸæœªå¤„ç†çš„ä»»åŠ¡
- âœ… æ— å¤±è´¥ä»»åŠ¡ï¼ˆæˆ–å¤±è´¥ç‡ < 1%ï¼‰

---

**æœ€åæ›´æ–°**: 2025-11-24
**ç»´æŠ¤äºº**: AIå¼€å‘å›¢é˜Ÿ
