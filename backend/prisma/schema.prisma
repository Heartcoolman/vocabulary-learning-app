generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String              @id @default(uuid())
  email            String              @unique
  passwordHash     String
  username         String
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  role             UserRole            @default(USER)
  rewardProfile    String              @default("standard")
  anomalyFlags     AnomalyFlag[]
  records          AnswerRecord[]
  habitProfile     HabitProfile?
  learningPlan     LearningPlan?
  learningSessions LearningSession[]
  rewardQueues     RewardQueue[]
  sessions         Session[]
  badges           UserBadge[]
  stateHistory     UserStateHistory[]
  studyConfig      UserStudyConfig?
  wordBooks        WordBook[]
  learningStates   WordLearningState[]
  reviewTraces     WordReviewTrace[]
  wordScores       WordScore[]

  @@index([rewardProfile])
  @@map("users")
}

model WordBook {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        WordBookType
  userId      String?
  isPublic    Boolean      @default(false)
  wordCount   Int          @default(0)
  coverImage  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  words       Word[]

  @@index([userId])
  @@index([type])
  @@map("word_books")
}

model Word {
  id             String              @id @default(uuid())
  spelling       String
  phonetic       String
  meanings       String[]
  examples       String[]
  audioUrl       String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  wordBookId     String
  anomalyFlags   AnomalyFlag[]
  records        AnswerRecord[]
  wordFrequency  WordFrequency?
  learningStates WordLearningState[]
  reviewTraces   WordReviewTrace[]
  wordScores     WordScore[]
  wordBook       WordBook            @relation(fields: [wordBookId], references: [id], onDelete: Cascade)

  @@unique([wordBookId, spelling], name: "unique_spelling_per_book")
  @@index([wordBookId])
  @@index([spelling])
  @@index([wordBookId, createdAt])
  @@map("words")
}

model WordFrequency {
  id             String   @id @default(uuid())
  wordId         String   @unique
  frequencyScore Decimal  @db.Decimal(5, 4)
  corpusSource   String?
  rawFrequency   Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  word           Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([frequencyScore])
  @@map("word_frequencies")
}

model AnswerRecord {
  id                 String           @default(uuid())
  userId             String
  wordId             String
  selectedAnswer     String
  correctAnswer      String
  isCorrect          Boolean
  timestamp          DateTime         @default(now())
  dwellTime          Int?
  masteryLevelAfter  Int?
  masteryLevelBefore Int?
  responseTime       Int?
  sessionId          String?
  session            LearningSession? @relation(fields: [sessionId], references: [id])
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  word               Word             @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@id([id, timestamp])
  @@unique([userId, wordId, timestamp], name: "unique_user_word_timestamp")
  @@index([userId])
  @@index([wordId])
  @@index([sessionId])
  @@index([userId, timestamp], map: "idx_answer_records_user_time")
  @@index([wordId, timestamp])
  @@index([userId, isCorrect])
  @@index([sessionId, timestamp])
  @@index([userId, wordId, isCorrect]) // 优化：单词正确率统计查询
  @@index([userId, timestamp(sort: Desc)], map: "idx_answer_records_user_time_desc") // 优化：最近答题记录查询
  @@map("answer_records")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model UserStudyConfig {
  id                  String   @id @default(uuid())
  userId              String   @unique
  selectedWordBookIds String[]
  dailyWordCount      Int      @default(20)
  studyMode           String   @default("sequential")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  dailyMasteryTarget  Int      @default(20)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_study_configs")
}

model WordLearningState {
  id                 String    @id @default(uuid())
  userId             String
  wordId             String
  state              WordState @default(NEW)
  masteryLevel       Int       @default(0)
  easeFactor         Float     @default(2.5)
  reviewCount        Int       @default(0)
  lastReviewDate     DateTime?
  nextReviewDate     DateTime?
  currentInterval    Int       @default(1)
  consecutiveCorrect Int       @default(0)
  consecutiveWrong   Int       @default(0)
  halfLife           Float     @default(1.0) // 个性化半衰期（天），基于用户表现动态调整
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  word               Word      @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId], name: "unique_user_word")
  @@index([userId])
  @@index([wordId])
  @@index([state])
  @@index([nextReviewDate])
  @@index([userId, state])
  @@index([userId, masteryLevel])
  @@index([userId, nextReviewDate])
  @@index([userId, nextReviewDate, state]) // 优化：到期复习词筛选
  @@index([userId, halfLife]) // 优化：按半衰期排序的复习优先级
  @@map("word_learning_states")
}

model WordScore {
  id                  String   @id @default(uuid())
  userId              String
  wordId              String
  totalScore          Float    @default(0)
  accuracyScore       Float    @default(0)
  speedScore          Float    @default(0)
  stabilityScore      Float    @default(0)
  proficiencyScore    Float    @default(0)
  totalAttempts       Int      @default(0)
  correctAttempts     Int      @default(0)
  averageResponseTime Float    @default(0)
  averageDwellTime    Float    @default(0)
  recentAccuracy      Float    @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word                Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId], name: "unique_user_word_score")
  @@index([userId])
  @@index([wordId])
  @@index([totalScore])
  @@index([userId, totalScore])
  @@map("word_scores")
}

model AlgorithmConfig {
  id                                String          @id @default(uuid())
  name                              String          @unique
  description                       String?
  reviewIntervals                   Int[]
  consecutiveCorrectThreshold       Int             @default(5)
  consecutiveWrongThreshold         Int             @default(3)
  difficultyAdjustmentInterval      Int             @default(1)
  priorityWeightNewWord             Int             @default(40)
  priorityWeightErrorRate           Int             @default(30)
  priorityWeightOverdueTime         Int             @default(20)
  priorityWeightWordScore           Int             @default(10)
  scoreWeightAccuracy               Int             @default(40)
  scoreWeightSpeed                  Int             @default(30)
  scoreWeightStability              Int             @default(20)
  scoreWeightProficiency            Int             @default(10)
  speedThresholdExcellent           Int             @default(3000)
  speedThresholdGood                Int             @default(5000)
  speedThresholdAverage             Int             @default(10000)
  speedThresholdSlow                Int             @default(10000)
  newWordRatioDefault               Float           @default(0.3)
  newWordRatioHighAccuracy          Float           @default(0.5)
  newWordRatioLowAccuracy           Float           @default(0.1)
  newWordRatioHighAccuracyThreshold Float           @default(0.85)
  newWordRatioLowAccuracyThreshold  Float           @default(0.65)
  masteryThresholds                 Json
  isDefault                         Boolean         @default(false)
  createdAt                         DateTime        @default(now())
  updatedAt                         DateTime        @updatedAt
  createdBy                         String?
  configHistory                     ConfigHistory[]

  @@map("algorithm_configs")
}

model ConfigHistory {
  id            String          @id @default(uuid())
  configId      String
  changedBy     String
  changeReason  String?
  previousValue Json
  newValue      Json
  timestamp     DateTime        @default(now())
  config        AlgorithmConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([changedBy])
  @@index([timestamp])
  @@map("config_history")
}

model AnomalyFlag {
  id         String    @id @default(uuid())
  userId     String
  wordId     String
  flaggedBy  String
  reason     String
  flaggedAt  DateTime  @default(now())
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  word       Word      @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId])
  @@index([wordId])
  @@index([flaggedAt])
  @@map("anomaly_flags")
}

model AmasUserState {
  id               String   @id @default(uuid())
  userId           String   @unique
  attention        Float    @default(0.7)
  fatigue          Float    @default(0)
  motivation       Float    @default(0)
  confidence       Float    @default(0.5)
  cognitiveProfile Json     @default("{\"mem\": 0.5, \"speed\": 0.5, \"stability\": 0.5}")
  habitProfile     Json?
  trendState       String?
  lastUpdateTs     BigInt   @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([lastUpdateTs])
  @@map("amas_user_states")
}

model AmasUserModel {
  id        String   @id @default(uuid())
  userId    String   @unique
  modelData Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("amas_user_models")
}

model LearningSession {
  id                 String          @id @default(uuid())
  userId             String
  startedAt          DateTime        @default(now())
  endedAt            DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  actualMasteryCount Int?
  targetMasteryCount Int?
  totalQuestions     Int?
  answerRecords      AnswerRecord[]
  featureVectors     FeatureVector[]
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  rewardQueues       RewardQueue[]

  @@index([userId, startedAt])
  @@map("learning_sessions")
}

model FeatureVector {
  sessionId      String
  featureVersion Int
  features       Json
  normMethod     String?
  createdAt      DateTime        @default(now())
  answerRecordId String
  session        LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@id([sessionId, featureVersion])
  @@unique([answerRecordId, featureVersion])
  @@index([featureVersion, createdAt])
  @@map("feature_vectors")
}

model HabitProfile {
  userId     String   @id
  timePref   Json?
  rhythmPref Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("habit_profiles")
}

model RewardQueue {
  id             String           @id @default(uuid())
  sessionId      String?
  userId         String
  dueTs          DateTime
  reward         Float
  status         RewardStatus     @default(PENDING)
  idempotencyKey String           @unique
  lastError      String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  answerRecordId String?
  session        LearningSession? @relation(fields: [sessionId], references: [id])
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([dueTs, status])
  @@index([userId])
  @@index([sessionId])
  @@index([userId, status, dueTs])
  @@index([answerRecordId], map: "idx_reward_queue_answerRecordId")
  @@map("reward_queue")
}

model UserStateHistory {
  id         String   @id @default(uuid())
  userId     String
  date       DateTime @db.Date
  attention  Float
  fatigue    Float
  motivation Float
  memory     Float
  speed      Float
  stability  Float
  trendState String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("user_state_history")
}

model BadgeDefinition {
  id          String        @id @default(uuid())
  name        String
  description String
  iconUrl     String
  category    BadgeCategory
  tier        Int           @default(1)
  condition   Json
  createdAt   DateTime      @default(now())
  userBadges  UserBadge[]

  @@unique([name, tier])
  @@map("badge_definitions")
}

model UserBadge {
  id         String          @id @default(uuid())
  userId     String
  badgeId    String
  tier       Int             @default(1)
  unlockedAt DateTime        @default(now())
  badge      BadgeDefinition @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId, tier])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

model LearningPlan {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  dailyTarget             Int
  estimatedCompletionDate DateTime
  wordbookDistribution    Json
  weeklyMilestones        Json
  isActive                Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  totalWords              Int      @default(0)
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("learning_plans")
}

/// A/B测试实验配置
model ABExperiment {
  id                      String                @id @default(uuid())
  name                    String
  description             String?
  trafficAllocation       ABTrafficAllocation   @default(WEIGHTED)
  minSampleSize           Int                   @default(100)
  significanceLevel       Float                 @default(0.05)
  minimumDetectableEffect Float                 @default(0.05)
  autoDecision            Boolean               @default(false)
  status                  ABExperimentStatus    @default(DRAFT)
  startedAt               DateTime?
  endedAt                 DateTime?
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  metrics                 ABExperimentMetrics[]
  assignments             ABUserAssignment[]
  variants                ABVariant[]

  @@index([status])
  @@index([startedAt])
  @@map("ab_experiments")
}

/// A/B测试变体
model ABVariant {
  id           String                @id @default(uuid())
  experimentId String
  name         String
  weight       Float                 @default(0.5)
  isControl    Boolean               @default(false)
  parameters   Json                  @default("{}")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  metrics      ABExperimentMetrics[]
  assignments  ABUserAssignment[]
  experiment   ABExperiment          @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId])
  @@map("ab_variants")
}

/// 用户变体分配（持久化）
model ABUserAssignment {
  userId       String
  experimentId String
  variantId    String
  assignedAt   DateTime     @default(now())
  experiment   ABExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant      ABVariant    @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@id([userId, experimentId])
  @@index([variantId])
  @@map("ab_user_assignments")
}

/// 实验指标数据
model ABExperimentMetrics {
  id            String       @id @default(uuid())
  experimentId  String
  variantId     String
  sampleCount   Int          @default(0)
  primaryMetric Float        @default(0)
  averageReward Float        @default(0)
  stdDev        Float        @default(0)
  m2            Float        @default(0)
  updatedAt     DateTime     @updatedAt
  experiment    ABExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant       ABVariant    @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([experimentId, variantId])
  @@map("ab_experiment_metrics")
}

/// 贝叶斯优化器状态持久化
model BayesianOptimizerState {
  id              String   @id @default("global")
  observations    Json     @default("[]")
  bestParams      Json?
  bestValue       Float?
  evaluationCount Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("bayesian_optimizer_state")
}

/// 因果推断观测数据
model CausalObservation {
  id        String   @default(uuid())
  userId    String?
  features  Json
  treatment Int
  outcome   Float
  timestamp BigInt
  createdAt DateTime @default(now())

  @@id([id, timestamp])
  @@index([treatment])
  @@index([timestamp])
  @@index([userId])
  @@map("causal_observations")
}

/// 单词复习轨迹记录
model WordReviewTrace {
  id           String   @default(cuid())
  userId       String
  wordId       String
  timestamp    DateTime
  isCorrect    Boolean
  responseTime Int
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word         Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@id([id, timestamp])
  @@index([userId, wordId])
  @@index([userId, wordId, timestamp])
  @@map("word_review_traces")
}

/// AMAS决策记录主表
model DecisionRecord {
  id              String                  @default(cuid())
  decisionId      String
  answerRecordId  String?
  sessionId       String?
  timestamp       DateTime                @default(now())
  decisionSource  String
  coldstartPhase  String?
  weightsSnapshot Json?
  memberVotes     Json?
  selectedAction  Json
  confidence      Float                   @default(0)
  reward          Float?
  traceVersion    Int                     @default(1)
  ingestionStatus DecisionIngestionStatus @default(PENDING)
  totalDurationMs Int?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  isSimulation    Boolean                 @default(false)

  @@id([id, timestamp])
  @@unique([decisionId, timestamp])
  @@index([answerRecordId])
  @@index([decisionSource])
  @@index([timestamp])
  @@index([sessionId])
  @@index([isSimulation])
  @@map("decision_records")
}

/// AMAS 决策洞察表（用于解释性读写与缓存）
model DecisionInsight {
  id                String   @id @default(cuid())
  decisionId        String   @unique @map("decision_id")
  userId            String   @map("user_id")
  stateSnapshot     Json     @map("state_snapshot")
  difficultyFactors Json     @map("difficulty_factors")
  triggers          String[] @default([])
  featureVectorHash String   @map("feature_vector_hash")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([userId, decisionId])
  @@index([featureVectorHash])
  @@index([createdAt])
  @@map("decision_insights")
}

/// 决策流水线阶段记�?
model PipelineStage {
  id               String              @id @default(cuid())
  decisionRecordId String
  stage            PipelineStageType
  stageName        String
  status           PipelineStageStatus
  startedAt        DateTime
  endedAt          DateTime?
  durationMs       Int?
  inputSummary     Json?
  outputSummary    Json?
  metadata         Json?
  errorMessage     String?
  createdAt        DateTime            @default(now())

  @@index([decisionRecordId, stage])
  @@index([stage])
  @@index([status])
  @@map("pipeline_stages")
}

model word_frequency {
  word_id         String   @id
  frequency_rank  Int
  frequency_score Decimal  @db.Decimal(5, 4)
  corpus_source   String
  updated_at      DateTime

  @@index([frequency_rank], map: "idx_word_frequency_rank")
  @@index([corpus_source], map: "idx_word_frequency_source")
}

enum UserRole {
  USER
  ADMIN
}

enum WordBookType {
  SYSTEM
  USER
}

enum WordState {
  NEW
  LEARNING
  REVIEWING
  MASTERED
}

enum RewardStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum BadgeCategory {
  STREAK
  ACCURACY
  COGNITIVE
  MILESTONE
}

enum ABExperimentStatus {
  DRAFT
  RUNNING
  COMPLETED
  ABORTED
}

enum ABTrafficAllocation {
  EVEN
  WEIGHTED
  DYNAMIC
}

/// 决策数据摄入状态
enum DecisionIngestionStatus {
  PENDING
  SUCCESS
  FAILED
}

/// 流水线阶段类型（对应AMAS六层架构）
enum PipelineStageType {
  PERCEPTION
  MODELING
  LEARNING
  DECISION
  EVALUATION
  OPTIMIZATION
}

/// 流水线阶段执行状态
enum PipelineStageStatus {
  STARTED
  SUCCESS
  FAILED
  SKIPPED
}

/// 多目标优化框架 - 用户学习目标配置
model UserLearningObjectives {
  id        String   @id @default(uuid())
  userId    String   @unique
  mode      String   @default("daily")  // 'exam' | 'daily' | 'travel' | 'custom'

  // 主要目标
  primaryObjective String @default("accuracy")

  // 约束条件
  minAccuracy      Float?
  maxDailyTime     Int?    // 分钟
  targetRetention  Float?

  // 权重配置
  weightShortTerm  Float   @default(0.4)
  weightLongTerm   Float   @default(0.4)
  weightEfficiency Float   @default(0.2)

  // 元数据
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_learning_objectives")
}

/// 多目标优化框架 - 目标历史追踪（用于A/B测试）
model ObjectiveHistory {
  id          String   @id @default(uuid())
  userId      String
  objectiveId String

  // 切换原因
  reason      String   // 'manual' | 'auto_adjust' | 'experiment'

  // 效果数据
  beforeMetrics Json   // 切换前的学习指标
  afterMetrics  Json   // 切换后的学习指标

  timestamp   DateTime @default(now())

  @@index([userId, timestamp])
  @@map("objective_history")
}

// ==================== 日志可视化系统 ====================

/// 系统日志存储表
model SystemLog {
  id        String    @id @default(uuid())
  level     LogLevel
  message   String
  module    String?
  source    LogSource @default(BACKEND)

  // 结构化数据
  context   Json?
  error     Json?     // { message, stack, name, code }

  // 请求追踪
  requestId String?
  userId    String?

  // 客户端信息（前端日志）
  clientIp  String?
  userAgent String?

  // 元数据
  app       String    @default("danci")
  env       String    @default("production")

  timestamp DateTime  @default(now())

  @@index([timestamp])
  @@index([level])
  @@index([module])
  @@index([source])
  @@index([userId])
  @@index([requestId])
  @@index([timestamp, level])
  @@map("system_logs")
}

/// 日志告警规则
model LogAlertRule {
  id             String     @id @default(uuid())
  name           String
  description    String?
  enabled        Boolean    @default(true)

  // 触发条件
  levels         LogLevel[] // 匹配的日志级别
  module         String?    // 匹配的模块（可选）
  messagePattern String?    // 消息正则匹配（可选）

  // 触发阈值
  threshold      Int        // 触发数量阈值
  windowMinutes  Int        // 时间窗口（分钟）

  // 通知配置
  webhookUrl     String?

  // 冷却
  cooldownMinutes Int       @default(30)
  lastTriggeredAt DateTime?

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@map("log_alert_rules")
}

/// 日志级别枚举
enum LogLevel {
  TRACE
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

/// 日志来源枚举
enum LogSource {
  BACKEND
  FRONTEND
}
