generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum WordBookType {
  SYSTEM
  USER
}

model User {
  id           String         @id @default(uuid())
  email        String         @unique
  passwordHash String
  username     String
  role         UserRole       @default(USER)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  wordBooks    WordBook[]
  records      AnswerRecord[]
  sessions     Session[]
  studyConfig  UserStudyConfig?
  learningStates WordLearningState[]
  wordScores     WordScore[]
  anomalyFlags   AnomalyFlag[]
  learningSessions LearningSession[]
  habitProfile     HabitProfile?
  rewardQueues     RewardQueue[]

  @@map("users")
}

model WordBook {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        WordBookType
  userId      String?      // null for SYSTEM wordbooks
  isPublic    Boolean      @default(false)
  wordCount   Int          @default(0)
  coverImage  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  words       Word[]

  @@index([userId])
  @@index([type])
  @@map("word_books")
}

model Word {
  id         String         @id @default(uuid())
  wordBookId String
  spelling   String
  phonetic   String
  meanings   String[]       // JSON array stored as text
  examples   String[]       // JSON array stored as text
  audioUrl   String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  wordBook   WordBook       @relation(fields: [wordBookId], references: [id], onDelete: Cascade)
  records    AnswerRecord[]
  learningStates WordLearningState[]
  wordScores     WordScore[]
  anomalyFlags   AnomalyFlag[]

  @@index([wordBookId])
  @@index([spelling])
  @@index([wordBookId, createdAt])
  @@unique([wordBookId, spelling], name: "unique_spelling_per_book")
  @@map("words")
}

model AnswerRecord {
  id                  String   @id @default(uuid())
  userId              String
  wordId              String
  selectedAnswer      String
  correctAnswer       String
  isCorrect           Boolean
  timestamp           DateTime @default(now())
  responseTime        Int?     // 响应时间（毫秒）
  dwellTime           Int?     // 停留时长（毫秒）
  sessionId           String?  // 学习会话ID
  masteryLevelBefore  Int?     // 答题前的掌握程度（0-5级）
  masteryLevelAfter   Int?     // 答题后的掌握程度（0-5级）
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word                Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId, timestamp], name: "unique_user_word_timestamp")
  @@index([userId])
  @@index([wordId])
  @@index([sessionId])
  @@index([userId, timestamp])
  @@index([wordId, timestamp])
  @@index([userId, isCorrect])
  @@index([sessionId, timestamp])
  @@map("answer_records")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model UserStudyConfig {
  id                   String   @id @default(uuid())
  userId               String   @unique
  selectedWordBookIds  String[] // JSON array of wordbook IDs
  dailyWordCount       Int      @default(20)
  studyMode            String   @default("sequential") // sequential, random, review
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_study_configs")
}

enum WordState {
  NEW
  LEARNING
  REVIEWING
  MASTERED
}

model WordLearningState {
  id                  String    @id @default(uuid())
  userId              String
  wordId              String
  state               WordState @default(NEW)
  masteryLevel        Int       @default(0) // 0-5级
  easeFactor          Float     @default(2.5) // 1.3-2.5
  reviewCount         Int       @default(0)
  lastReviewDate      DateTime?
  nextReviewDate      DateTime?
  currentInterval     Int       @default(1) // 天数
  consecutiveCorrect  Int       @default(0)
  consecutiveWrong    Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  word                Word      @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId], name: "unique_user_word")
  @@index([userId])
  @@index([wordId])
  @@index([state])
  @@index([nextReviewDate])
  @@index([userId, state])
  @@index([userId, masteryLevel])
  @@index([userId, nextReviewDate])
  @@map("word_learning_states")
}

model WordScore {
  id                   String   @id @default(uuid())
  userId               String
  wordId               String
  totalScore           Float    @default(0) // 0-100
  accuracyScore        Float    @default(0) // 0-40
  speedScore           Float    @default(0) // 0-30
  stabilityScore       Float    @default(0) // 0-20
  proficiencyScore     Float    @default(0) // 0-10
  totalAttempts        Int      @default(0)
  correctAttempts      Int      @default(0)
  averageResponseTime  Float    @default(0) // 毫秒
  averageDwellTime     Float    @default(0) // 毫秒
  recentAccuracy       Float    @default(0) // 0-1
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word                 Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId], name: "unique_user_word_score")
  @@index([userId])
  @@index([wordId])
  @@index([totalScore])
  @@index([userId, totalScore])
  @@map("word_scores")
}

model AlgorithmConfig {
  id                              String   @id @default(uuid())
  name                            String
  description                     String?
  reviewIntervals                 Int[]    // [1, 3, 7, 15, 30]
  consecutiveCorrectThreshold     Int      @default(5)
  consecutiveWrongThreshold       Int      @default(3)
  difficultyAdjustmentInterval    Int      @default(1)
  priorityWeightNewWord           Int      @default(40)
  priorityWeightErrorRate         Int      @default(30)
  priorityWeightOverdueTime       Int      @default(20)
  priorityWeightWordScore         Int      @default(10)
  scoreWeightAccuracy             Int      @default(40)
  scoreWeightSpeed                Int      @default(30)
  scoreWeightStability            Int      @default(20)
  scoreWeightProficiency          Int      @default(10)
  speedThresholdExcellent         Int      @default(3000)
  speedThresholdGood              Int      @default(5000)
  speedThresholdAverage           Int      @default(10000)
  speedThresholdSlow              Int      @default(10000)
  newWordRatioDefault             Float    @default(0.3)
  newWordRatioHighAccuracy        Float    @default(0.5)
  newWordRatioLowAccuracy         Float    @default(0.1)
  newWordRatioHighAccuracyThreshold Float  @default(0.85)
  newWordRatioLowAccuracyThreshold  Float  @default(0.65)
  masteryThresholds               Json     // JSON array of mastery level thresholds
  isDefault                       Boolean  @default(false)
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
  createdBy                       String?
  configHistory                   ConfigHistory[]

  @@map("algorithm_configs")
}

model ConfigHistory {
  id            String          @id @default(uuid())
  configId      String
  changedBy     String
  changeReason  String?
  previousValue Json            // Partial<AlgorithmConfig>
  newValue      Json            // Partial<AlgorithmConfig>
  timestamp     DateTime        @default(now())
  config        AlgorithmConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([changedBy])
  @@index([timestamp])
  @@map("config_history")
}

model AnomalyFlag {
  id         String   @id @default(uuid())
  userId     String
  wordId     String
  flaggedBy  String
  reason     String
  flaggedAt  DateTime @default(now())
  resolved   Boolean  @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word       Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId])
  @@index([wordId])
  @@index([flaggedAt])
  @@map("anomaly_flags")
}

// AMAS 用户状态持久化
model AmasUserState {
  id              String   @id @default(uuid())
  userId          String   @unique
  attention       Float    @default(0.7)   // A: 注意力 [0,1]
  fatigue         Float    @default(0)     // F: 疲劳度 [0,1]
  motivation      Float    @default(0)     // M: 动机 [-1,1]
  confidence      Float    @default(0.5)   // conf: 状态置信度 [0,1]
  cognitiveProfile Json    @default("{\"mem\":0.5,\"speed\":0.5,\"stability\":0.5}") // C: 认知能力画像
  habitProfile    Json?                     // H: 学习习惯画像 (可选)
  trendState      String?                   // T: 长期趋势 'up'|'flat'|'stuck'|'down'
  lastUpdateTs    BigInt   @default(0)     // ts: 最后更新时间戳
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([lastUpdateTs])
  @@map("amas_user_states")
}

// AMAS LinUCB 模型持久化
model AmasUserModel {
  id         String   @id @default(uuid())
  userId     String   @unique
  modelData  Json                          // LinUCB模型数据 (theta, A_inv, b)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@map("amas_user_models")
}

// 学习会话表 (AMAS扩展版)
model LearningSession {
  id             String          @id @default(uuid())
  userId         String
  startedAt      DateTime        @default(now())
  endedAt        DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  featureVectors FeatureVector[]
  rewardQueues   RewardQueue[]

  @@index([userId, startedAt])
  @@map("learning_sessions")
}

// 延迟奖励状态枚举
enum RewardStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

// 特征向量表 (AMAS扩展版 - 支持特征版本化)
model FeatureVector {
  sessionId      String          @id
  featureVersion Int
  features       Json
  normMethod     String?
  createdAt      DateTime        @default(now())
  session        LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([featureVersion, createdAt])
  @@map("feature_vectors")
}

// 用户习惯画像表 (AMAS扩展版)
model HabitProfile {
  userId     String   @id
  timePref   Json?    // 时间偏好 (24/48小时桶权重)
  rhythmPref Json?    // 节奏偏好 (学习周期/节奏分布)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("habit_profiles")
}

// 延迟奖励队列表 (AMAS扩展版)
model RewardQueue {
  id             String           @id @default(uuid())
  sessionId      String?
  userId         String
  dueTs          DateTime         // 奖励到期时间
  reward         Float            // 延迟奖励值
  status         RewardStatus     @default(PENDING)
  idempotencyKey String           @unique  // 幂等键
  lastError      String?          // 最后错误信息
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  session        LearningSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([dueTs, status])
  @@index([userId])
  @@index([sessionId])
  @@index([userId, status, dueTs])
  @@map("reward_queue")
}
