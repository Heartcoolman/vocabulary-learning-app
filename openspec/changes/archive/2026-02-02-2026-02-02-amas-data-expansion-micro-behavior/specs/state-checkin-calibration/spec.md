# çŠ¶æ€æ‰“å¡ä¸ç–²åŠ³æ ¡å‡†è§„æ ¼

## æ¦‚è¿°

å®ç°ä¼šè¯å¼€å§‹æ—¶çš„çŠ¶æ€æ‰“å¡åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·ä¸»åŠ¨æŠ¥å‘Šç²¾åŠ›çŠ¶æ€ï¼Œå¹¶å°†æ­¤ä¿¡æ¯ä½œä¸º TFM ç–²åŠ³æ¨¡å‹çš„æ ¡å‡†ä¿¡å·ã€‚

## ç”¨æˆ·å†³ç­–çº¦æŸ

| å†³ç­–é¡¹         | å†³ç­–ç»“æœ                      | è¯´æ˜                                      |
| -------------- | ----------------------------- | ----------------------------------------- |
| æ ¡å‡†å¸¸æ•°       | High=0.6, Normal=1.0, Low=1.4 | ä¿å®ˆæ ¡å‡†èŒƒå›´                              |
| ä¼šè¯åˆ›å»ºæ—¶æœº   | ä¸¤ç§è·¯å¾„å¹¶å­˜                  | æ”¯æŒå»¶è¿Ÿåˆ›å»ºï¼ˆæ‰“å¡åï¼‰å’Œç«‹å³åˆ›å»º+åç»­æ›´æ–° |
| æ— æ•ˆ energy å€¼ | æ‹’ç»è¯·æ±‚ (400)                | åç«¯ä¸¥æ ¼æ ¡éªŒï¼Œä¸æ¥å—éæ³•å€¼                |
| å¾®è¡Œä¸ºå­˜å‚¨å¤±è´¥ | å†™å…¥æ—¥å¿—åè¡¥                  | å¤±è´¥æ•°æ®å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œåç»­æ‰¹é‡è¡¥å…¥        |

## äº¤äº’è®¾è®¡

### çŠ¶æ€æ‰“å¡æµ®å±‚

**è§¦å‘æ—¶æœº**ï¼šç”¨æˆ·è¿›å…¥ LearningPage ä¸”å°šæœªå¼€å§‹å½“å‰ä¼šè¯çš„ç¬¬ä¸€é“é¢˜æ—¶ã€‚

**UI å¸ƒå±€**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä»Šå¤©çŠ¶æ€å¦‚ä½•ï¼Ÿ                      â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ğŸ¤¯    â”‚  â”‚  ğŸ˜    â”‚  â”‚  ğŸ˜«    â”‚     â”‚
â”‚  â”‚ç²¾åŠ›å……æ²› â”‚  â”‚å¹³å¹³æ·¡æ·¡ â”‚  â”‚ç²¾ç–²åŠ›å°½ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                          â”‚
â”‚          â”â”â”â”â” æˆ– â”â”â”â”â”                  â”‚
â”‚                                          â”‚
â”‚        [ è·³è¿‡ï¼Œä½¿ç”¨ä¸Šæ¬¡è®¾ç½® ]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’è¡Œä¸º**ï¼š

- ç‚¹å‡»ä»»ä¸€çŠ¶æ€å¡ç‰‡ â†’ ç«‹å³å…³é—­æµ®å±‚ï¼Œåº”ç”¨é€‰æ‹©ï¼Œå¼€å§‹å­¦ä¹ 
- ç‚¹å‡»"è·³è¿‡" â†’ ä½¿ç”¨ä¸Šæ¬¡çš„èƒ½é‡çº§åˆ«è®¾ç½®ï¼ˆé¦–æ¬¡ä½¿ç”¨é»˜è®¤ `normal`ï¼‰
- 3 ç§’æ— æ“ä½œ â†’ è‡ªåŠ¨ä½¿ç”¨é»˜è®¤å€¼ `normal`ï¼Œæµ®å±‚æ·¡å‡º
- æµ®å±‚ä¸ºéé˜»å¡å¼ï¼Œç”¨æˆ·ä»å¯çœ‹åˆ°èƒŒæ™¯ï¼ˆæ¨¡ç³Šå¤„ç†ï¼‰

### èƒ½é‡çº§åˆ«å®šä¹‰

| çº§åˆ«     | å€¼       | å«ä¹‰                       | ç®—æ³•å½±å“                         |
| -------- | -------- | -------------------------- | -------------------------------- |
| ç²¾åŠ›å……æ²› | `high`   | ç”¨æˆ·æ„Ÿè§‰ç²¾åŠ›æ—ºç››ï¼Œæƒ³è¦æŒ‘æˆ˜ | ç–²åŠ³æ£€æµ‹çµæ•åº¦é™ä½ï¼Œå…è®¸æ›´é«˜éš¾åº¦ |
| å¹³å¹³æ·¡æ·¡ | `normal` | æ ‡å‡†çŠ¶æ€                   | æ— æ ¡å‡†ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°             |
| ç²¾ç–²åŠ›å°½ | `low`    | ç”¨æˆ·æ„Ÿè§‰ç–²å€¦               | ç–²åŠ³æ£€æµ‹çµæ•åº¦æé«˜ï¼Œé™åˆ¶éš¾åº¦     |

## å‰ç«¯å®ç°

### çŠ¶æ€æ‰“å¡ç»„ä»¶

```typescript
// packages/frontend/src/components/StateCheckIn.tsx

import { useState, useEffect, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

export type EnergyLevel = 'high' | 'normal' | 'low';

interface StateCheckInProps {
  isOpen: boolean;
  onSelect: (level: EnergyLevel) => void;
  onSkip: () => void;
  defaultLevel?: EnergyLevel;
  autoCloseDelayMs?: number;
}

const ENERGY_OPTIONS = [
  { level: 'high' as const, emoji: 'ğŸ¤¯', label: 'ç²¾åŠ›å……æ²›' },
  { level: 'normal' as const, emoji: 'ğŸ˜', label: 'å¹³å¹³æ·¡æ·¡' },
  { level: 'low' as const, emoji: 'ğŸ˜«', label: 'ç²¾ç–²åŠ›å°½' },
];

export function StateCheckIn({
  isOpen,
  onSelect,
  onSkip,
  defaultLevel = 'normal',
  autoCloseDelayMs = 3000,
}: StateCheckInProps) {
  const [countdown, setCountdown] = useState(autoCloseDelayMs / 1000);

  // è‡ªåŠ¨å…³é—­å€’è®¡æ—¶
  useEffect(() => {
    if (!isOpen) return;

    const timer = setInterval(() => {
      setCountdown(prev => {
        if (prev <= 1) {
          onSelect(defaultLevel);
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, [isOpen, defaultLevel, onSelect]);

  // é‡ç½®å€’è®¡æ—¶
  useEffect(() => {
    if (isOpen) {
      setCountdown(autoCloseDelayMs / 1000);
    }
  }, [isOpen, autoCloseDelayMs]);

  const handleSelect = useCallback((level: EnergyLevel) => {
    onSelect(level);
  }, [onSelect]);

  return (
    <AnimatePresence>
      {isOpen && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 z-50 flex items-center justify-center"
        >
          {/* èƒŒæ™¯æ¨¡ç³Šé®ç½© */}
          <div className="absolute inset-0 bg-black/30 backdrop-blur-sm" />

          {/* æ‰“å¡å¡ç‰‡ */}
          <motion.div
            initial={{ scale: 0.9, y: 20 }}
            animate={{ scale: 1, y: 0 }}
            exit={{ scale: 0.9, y: 20 }}
            className="relative bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 mx-4 max-w-md w-full"
          >
            <h2 className="text-xl font-semibold text-center mb-6 text-gray-900 dark:text-white">
              ä»Šå¤©çŠ¶æ€å¦‚ä½•ï¼Ÿ
            </h2>

            {/* çŠ¶æ€é€‰é¡¹ */}
            <div className="flex justify-center gap-4 mb-6">
              {ENERGY_OPTIONS.map(({ level, emoji, label }) => (
                <button
                  key={level}
                  onClick={() => handleSelect(level)}
                  className="flex flex-col items-center p-4 rounded-xl border-2 border-transparent
                             hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20
                             transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <span className="text-4xl mb-2">{emoji}</span>
                  <span className="text-sm font-medium text-gray-700 dark:text-gray-300">
                    {label}
                  </span>
                </button>
              ))}
            </div>

            {/* åˆ†éš”çº¿ */}
            <div className="flex items-center gap-3 mb-4">
              <div className="flex-1 h-px bg-gray-200 dark:bg-gray-700" />
              <span className="text-sm text-gray-500">æˆ–</span>
              <div className="flex-1 h-px bg-gray-200 dark:bg-gray-700" />
            </div>

            {/* è·³è¿‡æŒ‰é’® */}
            <button
              onClick={onSkip}
              className="w-full py-2 text-sm text-gray-500 hover:text-gray-700
                         dark:text-gray-400 dark:hover:text-gray-200 transition-colors"
            >
              è·³è¿‡ï¼Œä½¿ç”¨ä¸Šæ¬¡è®¾ç½®
              <span className="ml-2 text-xs text-gray-400">
                ({countdown}s åè‡ªåŠ¨è·³è¿‡)
              </span>
            </button>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

### LearningPage é›†æˆ

```typescript
// packages/frontend/src/pages/LearningPage.tsx ä¿®æ”¹è¦ç‚¹

import { StateCheckIn, EnergyLevel } from '../components/StateCheckIn';
import { useLocalStorage } from '../hooks/useLocalStorage';

// åœ¨ç»„ä»¶å†…éƒ¨
const [showCheckIn, setShowCheckIn] = useState(false);
const [lastEnergyLevel, setLastEnergyLevel] = useLocalStorage<EnergyLevel>(
  'amas_last_energy_level',
  'normal'
);

// æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ‰“å¡
useEffect(() => {
  // ä»…åœ¨ä¼šè¯å¼€å§‹å‰ã€ç¬¬ä¸€é“é¢˜æ¸²æŸ“å‰æ˜¾ç¤º
  if (!sessionStarted && !sessionId && wordQueue.length > 0) {
    setShowCheckIn(true);
  }
}, [sessionStarted, sessionId, wordQueue.length]);

// å¤„ç†çŠ¶æ€é€‰æ‹©
const handleEnergySelect = useCallback(async (level: EnergyLevel) => {
  setShowCheckIn(false);
  setLastEnergyLevel(level);

  // åˆ›å»ºä¼šè¯æ—¶ä¼ é€’èƒ½é‡çº§åˆ«
  await createSession({
    targetMasteryCount,
    selfReportedEnergy: level,
  });
}, [createSession, targetMasteryCount, setLastEnergyLevel]);

// å¤„ç†è·³è¿‡
const handleSkip = useCallback(() => {
  handleEnergySelect(lastEnergyLevel);
}, [handleEnergySelect, lastEnergyLevel]);

// æ¸²æŸ“
return (
  <>
    <StateCheckIn
      isOpen={showCheckIn}
      onSelect={handleEnergySelect}
      onSkip={handleSkip}
      defaultLevel={lastEnergyLevel}
    />
    {/* ... existing content */}
  </>
);
```

## åç«¯å®ç°

### API æ‰©å±•

```rust
// packages/backend-rust/src/routes/learning_sessions.rs

#[derive(Debug, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct CreateSessionRequest {
    pub session_type: Option<String>,
    pub target_mastery_count: Option<i32>,
    #[serde(default)]
    pub self_reported_energy: Option<String>,  // "high" | "normal" | "low"
}

async fn create_session(
    State(state): State<AppState>,
    headers: HeaderMap,
    Json(body): Json<CreateSessionRequest>,
) -> Result<impl IntoResponse, AppError> {
    let (proxy, user) = require_user(&state, &headers).await?;

    // éªŒè¯èƒ½é‡çº§åˆ« - ä¸¥æ ¼æ ¡éªŒï¼Œæ— æ•ˆå€¼è¿”å› 400
    let energy_level = match body.self_reported_energy.as_deref() {
        Some("high") => Some("high"),
        Some("normal") => Some("normal"),
        Some("low") => Some("low"),
        Some(invalid) => {
            return Err(AppError::BadRequest(format!(
                "Invalid energy level: '{}'. Must be 'high', 'normal', or 'low'",
                invalid
            )));
        }
        None => None,
    };

    // åˆ›å»ºä¼šè¯
    let session = create_learning_session(
        proxy.pool(),
        &user.id,
        body.session_type.as_deref(),
        body.target_mastery_count,
        energy_level,
    ).await?;

    // å¦‚æœæœ‰èƒ½é‡çº§åˆ«ï¼Œåˆå§‹åŒ– TFM æ ¡å‡†
    if let Some(level) = energy_level {
        initialize_fatigue_calibration(proxy.as_ref(), &user.id, &session.id, level).await?;
    }

    Ok(Json(SuccessResponse {
        success: true,
        data: session,
    }))
}
```

### ç–²åŠ³æ¨¡å‹æ ¡å‡†

```rust
// packages/backend-rust/src/amas/modeling/tfm.rs

#[derive(Debug, Clone, Copy, PartialEq)]
pub enum EnergyLevel {
    High,
    Normal,
    Low,
}

impl EnergyLevel {
    pub fn from_str(s: &str) -> Option<Self> {
        match s {
            "high" => Some(Self::High),
            "normal" => Some(Self::Normal),
            "low" => Some(Self::Low),
            _ => None,
        }
    }

    /// è·å–ç–²åŠ³æ£€æµ‹çš„æ ¡å‡†å› å­ï¼ˆç”¨æˆ·å†³ç­–ç¡®å®šï¼‰
    /// - High: 0.6 (é™ä½æ£€æµ‹çµæ•åº¦ï¼Œç”¨æˆ·è‡ªè®¤ä¸ºç²¾åŠ›å……æ²›)
    /// - Normal: 1.0 (æ— æ ¡å‡†)
    /// - Low: 1.4 (æé«˜æ£€æµ‹çµæ•åº¦ï¼Œç”¨æˆ·è‡ªè®¤ä¸ºç–²å€¦)
    pub fn fatigue_calibration_factor(&self) -> f64 {
        match self {
            Self::High => 0.6,
            Self::Normal => 1.0,
            Self::Low => 1.4,
        }
    }

    /// è·å–éš¾åº¦ä¸Šé™çº¦æŸ
    /// - High: None (æ— é™åˆ¶)
    /// - Normal: None (æ— é™åˆ¶)
    /// - Low: Some(DifficultyLevel::Easy) (é™åˆ¶ä¸ºç®€å•éš¾åº¦)
    pub fn difficulty_ceiling(&self) -> Option<DifficultyLevel> {
        match self {
            Self::High | Self::Normal => None,
            Self::Low => Some(DifficultyLevel::Easy),
        }
    }

    /// è·å–æ–°è¯æ¯”ä¾‹ä¸Šé™
    /// - High: 0.4 (å…è®¸æ›´å¤šæ–°è¯)
    /// - Normal: 0.3 (æ ‡å‡†)
    /// - Low: 0.0 (ä¸å¼•å…¥æ–°è¯)
    pub fn new_ratio_ceiling(&self) -> f64 {
        match self {
            Self::High => 0.4,
            Self::Normal => 0.3,
            Self::Low => 0.0,
        }
    }
}

impl TriPoolFatigue {
    /// ä½¿ç”¨ç”¨æˆ·æŠ¥å‘Šçš„èƒ½é‡çº§åˆ«æ ¡å‡†ç–²åŠ³çŠ¶æ€
    pub fn calibrate_with_energy_level(
        &self,
        state: &mut TriPoolFatigueState,
        energy_level: EnergyLevel,
    ) {
        let factor = energy_level.fatigue_calibration_factor();

        // åº”ç”¨æ ¡å‡†å› å­åˆ°å½“å‰ç–²åŠ³æ°´å¹³
        // è¿™ä¼šå½±å“åç»­æ‰€æœ‰åŸºäºå½“å‰çŠ¶æ€çš„ç–²åŠ³æ£€æµ‹
        state.cognitive.fast *= factor;
        state.cognitive.slow *= factor;
        state.mental.fast *= factor;
        state.mental.slow *= factor;

        // è§†è§‰ç–²åŠ³ä¸å—ä¸»è§‚æŠ¥å‘Šå½±å“ï¼ˆåŸºäºå®¢è§‚æ£€æµ‹ï¼‰
        // state.visual ä¿æŒä¸å˜

        // ç¡®ä¿å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
        state.cognitive.fast = state.cognitive.fast.clamp(0.0, 1.0);
        state.cognitive.slow = state.cognitive.slow.clamp(0.0, 1.0);
        state.mental.fast = state.mental.fast.clamp(0.0, 1.0);
        state.mental.slow = state.mental.slow.clamp(0.0, 1.0);
    }
}
```

### ç­–ç•¥çº¦æŸåº”ç”¨

```rust
// packages/backend-rust/src/amas/decision/ensemble.rs

impl EnsembleDecision {
    pub fn post_filter_with_calibration(
        &self,
        strategy: &mut StrategyParams,
        user_state: &UserState,
        session_info: Option<&SessionInfo>,
        energy_level: Option<EnergyLevel>,
    ) {
        // åŸæœ‰å®‰å…¨è¿‡æ»¤...
        self.post_filter(strategy, user_state, session_info);

        // åº”ç”¨èƒ½é‡çº§åˆ«çº¦æŸ
        if let Some(level) = energy_level {
            // éš¾åº¦ä¸Šé™çº¦æŸ
            if let Some(ceiling) = level.difficulty_ceiling() {
                if strategy.difficulty > ceiling {
                    strategy.difficulty = ceiling;
                }
            }

            // æ–°è¯æ¯”ä¾‹ä¸Šé™çº¦æŸ
            let new_ratio_ceiling = level.new_ratio_ceiling();
            if strategy.new_ratio > new_ratio_ceiling {
                strategy.new_ratio = new_ratio_ceiling;
            }

            // Low èƒ½é‡ç‰¹æ®Šå¤„ç†ï¼šå¢åŠ æç¤ºçº§åˆ«
            if level == EnergyLevel::Low && strategy.hint_level < 2 {
                strategy.hint_level = 2;
            }
        }
    }
}
```

### ä¼šè¯çŠ¶æ€å­˜å‚¨

```rust
// packages/backend-rust/src/services/learning_session.rs

pub async fn create_learning_session(
    pool: &PgPool,
    user_id: &str,
    session_type: Option<&str>,
    target_mastery_count: Option<i32>,
    energy_level: Option<&str>,
) -> Result<LearningSession, AppError> {
    let session_id = Uuid::new_v4().to_string();
    let now = Utc::now();

    sqlx::query!(
        r#"
        INSERT INTO learning_sessions (
            id, user_id, session_type, target_mastery_count,
            self_reported_energy, started_at
        )
        VALUES ($1, $2, $3, $4, $5, $6)
        "#,
        session_id,
        user_id,
        session_type.unwrap_or("NORMAL"),
        target_mastery_count.unwrap_or(10),
        energy_level,
        now
    )
    .execute(pool)
    .await?;

    Ok(LearningSession {
        id: session_id,
        user_id: user_id.to_string(),
        session_type: session_type.unwrap_or("NORMAL").to_string(),
        target_mastery_count: target_mastery_count.unwrap_or(10),
        self_reported_energy: energy_level.map(String::from),
        started_at: now,
        ended_at: None,
    })
}
```

## æ•°æ®åº“ Schema

```sql
-- æ‰©å±• learning_sessions è¡¨
ALTER TABLE learning_sessions
ADD COLUMN IF NOT EXISTS self_reported_energy VARCHAR(16);

COMMENT ON COLUMN learning_sessions.self_reported_energy IS
    'ç”¨æˆ·è‡ªæŠ¥å‘Šçš„ç²¾åŠ›çŠ¶æ€: high, normal, low';

-- æ ¡å‡†å†å²è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºé•¿æœŸå­¦ä¹ ç”¨æˆ·åå¥½ï¼‰
CREATE TABLE IF NOT EXISTS fatigue_calibration_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id TEXT NOT NULL,
    session_id TEXT NOT NULL,
    reported_energy VARCHAR(16) NOT NULL,
    detected_fatigue_before REAL,
    detected_fatigue_after REAL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_session FOREIGN KEY (session_id) REFERENCES learning_sessions(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_fch_user ON fatigue_calibration_history(user_id);

COMMENT ON TABLE fatigue_calibration_history IS
    'è®°å½•ç”¨æˆ·è‡ªæŠ¥å‘Šèƒ½é‡ä¸ç³»ç»Ÿæ£€æµ‹ç–²åŠ³çš„å¯¹åº”å…³ç³»ï¼Œç”¨äºé•¿æœŸæ ¡å‡†';
```

## åˆ†æä¸æ ¡å‡†å­¦ä¹ 

### é•¿æœŸæ ¡å‡†æœºåˆ¶ï¼ˆP2 åŠŸèƒ½ï¼‰

ç³»ç»Ÿå¯ä»¥é€šè¿‡æ”¶é›† `fatigue_calibration_history` æ•°æ®ï¼Œå­¦ä¹ æ¯ä¸ªç”¨æˆ·çš„ä¸»è§‚æŠ¥å‘Šä¸å®¢è§‚ç–²åŠ³æ£€æµ‹ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼š

```rust
/// è®¡ç®—ç”¨æˆ·ä¸ªäººçš„æ ¡å‡†ç³»æ•°
/// åŸºäºå†å²æ•°æ®å­¦ä¹ ç”¨æˆ·çš„ä¸»è§‚æ„ŸçŸ¥ä¸å®¢è§‚æ£€æµ‹çš„åå·®
pub async fn compute_personal_calibration(
    pool: &PgPool,
    user_id: &str,
) -> Result<PersonalCalibration, AppError> {
    let history = sqlx::query_as!(
        CalibrationRecord,
        r#"
        SELECT reported_energy, detected_fatigue_before, detected_fatigue_after
        FROM fatigue_calibration_history
        WHERE user_id = $1
        ORDER BY created_at DESC
        LIMIT 50
        "#,
        user_id
    )
    .fetch_all(pool)
    .await?;

    if history.len() < 10 {
        // æ•°æ®ä¸è¶³ï¼Œä½¿ç”¨é»˜è®¤æ ¡å‡†
        return Ok(PersonalCalibration::default());
    }

    // è®¡ç®—æ¯ä¸ªèƒ½é‡çº§åˆ«çš„å¹³å‡æ£€æµ‹åå·®
    let high_samples: Vec<_> = history.iter()
        .filter(|r| r.reported_energy == "high")
        .collect();
    let low_samples: Vec<_> = history.iter()
        .filter(|r| r.reported_energy == "low")
        .collect();

    // å­¦ä¹ ç”¨æˆ·çš„æ„ŸçŸ¥åå·®
    // å¦‚æœç”¨æˆ·æŠ¥å‘Š "high" ä½†ç³»ç»Ÿé¢‘ç¹æ£€æµ‹åˆ°é«˜ç–²åŠ³ï¼Œè¯´æ˜ç”¨æˆ·å¯¹ç–²åŠ³ä¸æ•æ„Ÿ
    // å¦‚æœç”¨æˆ·æŠ¥å‘Š "low" ä½†ç³»ç»Ÿæ£€æµ‹åˆ°ä½ç–²åŠ³ï¼Œè¯´æ˜ç”¨æˆ·å¯¹ç–²åŠ³è¿‡åº¦æ•æ„Ÿ

    Ok(PersonalCalibration {
        high_factor: compute_factor_from_samples(&high_samples),
        low_factor: compute_factor_from_samples(&low_samples),
        sample_count: history.len(),
    })
}
```

## æµ‹è¯•ç”¨ä¾‹

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_energy_level_parsing() {
        assert_eq!(EnergyLevel::from_str("high"), Some(EnergyLevel::High));
        assert_eq!(EnergyLevel::from_str("normal"), Some(EnergyLevel::Normal));
        assert_eq!(EnergyLevel::from_str("low"), Some(EnergyLevel::Low));
        assert_eq!(EnergyLevel::from_str("invalid"), None);
    }

    #[test]
    fn test_fatigue_calibration() {
        let tfm = TriPoolFatigue::default();
        let mut state = TriPoolFatigueState {
            cognitive: FatiguePool { fast: 0.5, slow: 0.3 },
            visual: FatiguePool { fast: 0.4, slow: 0.2 },
            mental: FatiguePool { fast: 0.6, slow: 0.4 },
        };

        // ç”¨æˆ·æŠ¥å‘Šç²¾åŠ›å……æ²›
        tfm.calibrate_with_energy_level(&mut state, EnergyLevel::High);

        // è®¤çŸ¥å’Œå¿ƒç†ç–²åŠ³åº”è¯¥é™ä½
        assert!(state.cognitive.fast < 0.5);
        assert!(state.mental.fast < 0.6);
        // è§†è§‰ç–²åŠ³ä¿æŒä¸å˜
        assert_eq!(state.visual.fast, 0.4);
    }

    #[test]
    fn test_strategy_constraint_low_energy() {
        let ensemble = EnsembleDecision::default();
        let mut strategy = StrategyParams {
            difficulty: DifficultyLevel::Hard,
            new_ratio: 0.3,
            batch_size: 10,
            interval_scale: 1.0,
            hint_level: 0,
        };

        ensemble.post_filter_with_calibration(
            &mut strategy,
            &UserState::default(),
            None,
            Some(EnergyLevel::Low),
        );

        // Low èƒ½é‡åº”è¯¥é™åˆ¶éš¾åº¦å’Œæ–°è¯
        assert_eq!(strategy.difficulty, DifficultyLevel::Easy);
        assert_eq!(strategy.new_ratio, 0.0);
        assert_eq!(strategy.hint_level, 2);
    }
}
```

## æˆåŠŸæ ‡å‡†

1. **æ‰“å¡æµ®å±‚æ­£å¸¸æ˜¾ç¤º**ï¼šè¿›å…¥ LearningPage æ—¶æµ®å±‚å‡ºç°ï¼Œé€‰æ‹©åæ¶ˆå¤±
2. **èƒ½é‡çº§åˆ«æ­£ç¡®ä¼ é€’**ï¼š`learning_sessions` è¡¨è®°å½• `self_reported_energy`
3. **ç–²åŠ³æ ¡å‡†ç”Ÿæ•ˆ**ï¼šæŠ¥å‘Š `low` åç³»ç»Ÿæ›´å¿«è§¦å‘ç–²åŠ³è­¦å‘Š
4. **ç­–ç•¥çº¦æŸç”Ÿæ•ˆ**ï¼šæŠ¥å‘Š `low` åä¸å‡ºç° Hard éš¾åº¦é¢˜ç›®ï¼Œä¸å¼•å…¥æ–°è¯
5. **è‡ªåŠ¨è·³è¿‡æ­£å¸¸å·¥ä½œ**ï¼š3 ç§’æ— æ“ä½œåä½¿ç”¨é»˜è®¤å€¼
6. **ä¸Šæ¬¡è®¾ç½®è®°å¿†**ï¼šåˆ·æ–°é¡µé¢åä»èƒ½ä½¿ç”¨ä¸Šæ¬¡çš„èƒ½é‡çº§åˆ«

## Property-Based Testing è§„æ ¼

### èƒ½é‡çº§åˆ«æ ¡å‡† PBT å±æ€§

| å±æ€§å                          | ç±»å‹             | ä¸å˜é‡å®šä¹‰                                                                                  | ä¼ªé€ ç­–ç•¥                                                                                  |
| ------------------------------- | ---------------- | ------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| `calibration_visual_unchanged`  | Invariant        | åº”ç”¨ä»»æ„æ ¡å‡†å› å­åï¼Œ`visual.fast` å’Œ `visual.slow` ä¿æŒä¸å˜                                 | ç”Ÿæˆéšæœº `TriPoolFatigueState`ï¼Œåº”ç”¨æ ¡å‡†ï¼Œæ–­è¨€ visual æ± æœªå˜                              |
| `calibration_bounds`            | Bounds           | æ ¡å‡†åæ¯ä¸ªæ± ç»„ä»¶ä¿æŒåœ¨ `[0, 1]` èŒƒå›´å†…                                                      | ç”Ÿæˆè¶Šç•Œè¾“å…¥ï¼ˆè´Ÿæ•°ã€>1ï¼‰å’Œæç«¯å› å­ï¼Œæ–­è¨€è¾“å‡º clamp åˆ°èŒƒå›´å†…ä¸”æ—  NaN/Inf                   |
| `calibration_monotonic`         | Monotonicity     | å¯¹äº `0 < f1 <= f2` ä¸”å€¼æœªè§¦åŠ clampï¼Œ`calibrate(x, f1) <= calibrate(x, f2)`                | ç”Ÿæˆ `x âˆˆ (0, 1)` å’Œå› å­ `{0.0+, 0.6, 1.0, 1.4, huge}`ï¼Œè¿‡æ»¤ clamp é¥±å’Œæƒ…å†µï¼Œæ–­è¨€å•è°ƒç¼©æ”¾ |
| `calibration_composable`        | Compositionality | ä¸¤æ¬¡æ ¡å‡†ä¹˜æ³•å¯ç»„åˆï¼š`calibrate(calibrate(x, f1), f2) == calibrate(x, f1*f2)`ï¼ˆæœª clamp æ—¶ï¼‰ | ç”Ÿæˆ `x` å’Œ `(f1, f2)` ä½¿å¾— `x*f1*f2 âˆˆ (0, 1)`ï¼Œæ–­è¨€åœ¨æµ®ç‚¹å®¹å·®å†…ç›¸ç­‰                      |
| `calibration_idempotent_normal` | Idempotency      | `EnergyLevel::Normal` (factor=1.0) åº”ç”¨åçŠ¶æ€ä¸å˜                                           | ç”ŸæˆéšæœºçŠ¶æ€ï¼Œåº”ç”¨ Normal æ ¡å‡†ï¼Œæ–­è¨€æ‰€æœ‰å­—æ®µç›¸ç­‰                                          |

### ç­–ç•¥çº¦æŸ PBT å±æ€§

| å±æ€§å                          | ç±»å‹      | ä¸å˜é‡å®šä¹‰                                                           | ä¼ªé€ ç­–ç•¥                                                                           |
| ------------------------------- | --------- | -------------------------------------------------------------------- | ---------------------------------------------------------------------------------- |
| `low_energy_difficulty_ceiling` | Invariant | `EnergyLevel::Low` å `strategy.difficulty <= DifficultyLevel::Easy` | ç”Ÿæˆåˆå§‹ strategy ä¸ºä»»æ„ difficultyï¼Œåº”ç”¨ Low çº¦æŸï¼Œæ–­è¨€ difficulty ä¸è¶…è¿‡ Easy    |
| `low_energy_new_ratio_zero`     | Invariant | `EnergyLevel::Low` å `strategy.new_ratio == 0.0`                    | ç”Ÿæˆåˆå§‹ strategy ä¸ºä»»æ„ new_ratioï¼Œåº”ç”¨ Low çº¦æŸï¼Œæ–­è¨€ new_ratio ä¸º 0             |
| `low_energy_hint_minimum`       | Invariant | `EnergyLevel::Low` å `strategy.hint_level >= 2`                     | ç”Ÿæˆåˆå§‹ hint_level âˆˆ {0, 1, 2, 3}ï¼Œåº”ç”¨ Low çº¦æŸï¼Œæ–­è¨€ hint_level >= 2            |
| `high_normal_no_ceiling`        | Invariant | `EnergyLevel::High/Normal` ä¸å¼ºåˆ¶é™ä½ difficulty                     | ç”Ÿæˆ strategy ä¸º Hard difficultyï¼Œåº”ç”¨ High/Normal çº¦æŸï¼Œæ–­è¨€ difficulty ä¿æŒ Hard |

### API æ ¡éªŒ PBT å±æ€§

| å±æ€§å                    | ç±»å‹      | ä¸å˜é‡å®šä¹‰                                              | ä¼ªé€ ç­–ç•¥                                                                             |
| ------------------------- | --------- | ------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| `invalid_energy_rejected` | Invariant | é `high/normal/low` çš„ `self_reported_energy` è¿”å› 400 | ç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼ˆå« "High", "LOW", "", "medium", null å­—ç¬¦ä¸²ç­‰ï¼‰ï¼Œæ–­è¨€è¿”å› BadRequest |
| `valid_energy_accepted`   | Invariant | `high/normal/low` æ€»æ˜¯è¢«æ¥å—                            | ç”Ÿæˆè¿™ä¸‰ä¸ªå€¼çš„éšæœºé€‰æ‹©ï¼Œæ–­è¨€è¯·æ±‚æˆåŠŸ                                                 |
| `missing_energy_optional` | Invariant | `self_reported_energy` ç¼ºå¤±æ—¶è¯·æ±‚æˆåŠŸï¼Œä½¿ç”¨ None        | ç”Ÿæˆæ—  energy å­—æ®µçš„è¯·æ±‚ï¼Œæ–­è¨€æˆåŠŸä¸” session.energy ä¸º None                          |

### å‰ç«¯çŠ¶æ€ PBT å±æ€§

| å±æ€§å                   | ç±»å‹         | ä¸å˜é‡å®šä¹‰                                         | ä¼ªé€ ç­–ç•¥                                                   |
| ------------------------ | ------------ | -------------------------------------------------- | ---------------------------------------------------------- |
| `countdown_decreases`    | Monotonicity | å€’è®¡æ—¶ä»åˆå§‹å€¼å•è°ƒé€’å‡ç›´åˆ° 0                       | æ¨¡æ‹Ÿæ—¶é—´æµé€ï¼Œæ–­è¨€ countdown å€¼å•è°ƒé€’å‡                    |
| `auto_select_on_zero`    | Invariant    | å€’è®¡æ—¶åˆ° 0 æ—¶è§¦å‘ `onSelect(defaultLevel)`         | æ¨¡æ‹Ÿ 3 ç§’æ— æ“ä½œï¼Œæ–­è¨€ onSelect è¢«è°ƒç”¨ä¸”å‚æ•°ä¸º defaultLevel |
| `localStorage_roundtrip` | Round-trip   | `setLastEnergyLevel(x)` å `lastEnergyLevel === x` | å¯¹ä¸‰ä¸ªæœ‰æ•ˆå€¼åˆ†åˆ«å­˜å‚¨å’Œè¯»å–ï¼Œæ–­è¨€ç›¸ç­‰                       |

## ADDED Requirements

### Requirement: çŠ¶æ€æ‰“å¡ç»„ä»¶ (REQ-CHECKIN-001)

å‰ç«¯ SHALL æä¾› `StateCheckIn` ç»„ä»¶ï¼Œåœ¨ä¼šè¯å¼€å§‹æ—¶è¯¢é—®ç”¨æˆ·å½“å‰ç²¾åŠ›çŠ¶æ€ã€‚

#### Scenario: ç”¨æˆ·é€‰æ‹©ç²¾åŠ›çŠ¶æ€

- Given ç”¨æˆ·è¿›å…¥ LearningPage
- When é¢˜ç›®åˆ—è¡¨åŠ è½½å®Œæˆä¸”å°šæœªä½œç­”
- Then æ˜¾ç¤ºçŠ¶æ€æ‰“å¡æµ®å±‚
- And ç”¨æˆ·ç‚¹å‡» "ç²¾åŠ›å……æ²›"/"å¹³å¹³æ·¡æ·¡"/"ç²¾ç–²åŠ›å°½" ä¸­ä»»ä¸€é€‰é¡¹
- And æµ®å±‚å…³é—­ï¼Œè®°å½•é€‰æ‹©åˆ° localStorageï¼Œå¼€å§‹å­¦ä¹ 

### Requirement: è‡ªåŠ¨è·³è¿‡ä¸é»˜è®¤å€¼ (REQ-CHECKIN-002)

æ‰“å¡ç»„ä»¶ SHALL æ”¯æŒ 3 ç§’è‡ªåŠ¨è·³è¿‡ï¼Œä½¿ç”¨ä¸Šæ¬¡é€‰æ‹©æˆ–é»˜è®¤å€¼ `normal`ã€‚

#### Scenario: 3 ç§’æ— æ“ä½œè‡ªåŠ¨è·³è¿‡

- Given æ‰“å¡æµ®å±‚æ˜¾ç¤º
- When ç”¨æˆ· 3 ç§’å†…æ— ä»»ä½•æ“ä½œ
- Then è‡ªåŠ¨ä½¿ç”¨é»˜è®¤å€¼ `normal` å…³é—­æµ®å±‚
- And å¼€å§‹å­¦ä¹ 

### Requirement: TFM ç–²åŠ³æ ¡å‡† (REQ-CHECKIN-003)

åç«¯ SHALL æ ¹æ®ç”¨æˆ·æŠ¥å‘Šçš„ç²¾åŠ›çŠ¶æ€æ ¡å‡† TFM ç–²åŠ³æ¨¡å‹ã€‚

#### Scenario: Low èƒ½é‡æ ¡å‡†

- Given ç”¨æˆ·é€‰æ‹© "ç²¾ç–²åŠ›å°½" (low)
- When åˆ›å»ºå­¦ä¹ ä¼šè¯æ—¶ä¼ é€’ `selfReportedEnergy: "low"`
- Then TFM åº”ç”¨æ ¡å‡†å› å­ 1.4 (æé«˜ç–²åŠ³æ£€æµ‹çµæ•åº¦)
- And éš¾åº¦ä¸Šé™çº¦æŸä¸º Easy
- And æ–°è¯æ¯”ä¾‹ä¸Šé™çº¦æŸä¸º 0

### Requirement: API ä¸¥æ ¼æ ¡éªŒ (REQ-CHECKIN-004)

åç«¯ MUST å¯¹ energy level è¿›è¡Œä¸¥æ ¼æ ¡éªŒï¼Œæ‹’ç»éæ³•å€¼ã€‚

#### Scenario: éæ³• energy å€¼è¿”å› 400

- Given è¯·æ±‚åŒ…å« `selfReportedEnergy: "medium"`
- When è°ƒç”¨åˆ›å»ºä¼šè¯ API
- Then è¿”å› 400 Bad Request
- And é”™è¯¯æ¶ˆæ¯è¯´æ˜æœ‰æ•ˆå€¼ä¸º 'high', 'normal', 'low'
