# Proposal: Fix Audit Critical Issues

## Summary

修复Danci全功能审计中发现的严重问题，确保核心功能正常工作。本提案聚焦于P0级别的8个严重问题，这些问题导致关键功能完全不可用。

## Why

8个P0严重问题直接影响产品可用性：

1. **用户无法自助恢复账户** - 密码重置返回501，用户流失风险高
2. **管理功能形同虚设** - 内容质量检查全是存根，管理员无法工作
3. **数据隔离缺失** - StorageService忽略userId可能导致数据泄露
4. **监控不可信** - 健康检查不反映真实状态，故障无法及时发现

这些问题阻碍了产品进入生产环境。

## Motivation

### Problem Statement

2025-01-25全功能审计发现76个问题，其中8个为严重问题（P0）：

1. **密码重置功能完全不工作** - `request_password_reset`返回501 NOT_IMPLEMENTED，用户无法自助恢复账户
2. **内容质量检查9个端点全为存根** - admin/content.rs中所有路由返回`not_implemented()`
3. **AMAS历史端点未验证** - HistoryPage调用的3个端点实现状态不明
4. **StorageService忽略userId** - `getWordLearningStates`参数被忽略
5. **因果推理模块禁用** - 返回"disabled"状态
6. **洞察生成分群统计失效** - segment参数未使用
7. **LLM任务批量操作无效** - UI显示多选但只支持单操作
8. **嵌入服务健康检查无效** - 只读统计不验证连接

### Impact

- **用户体验**: 忘记密码的用户无法自助恢复，必须联系管理员
- **管理员功能**: 内容质量管理界面完全无法使用
- **数据一致性**: 多个后端服务返回不正确或存根数据
- **监控可靠性**: 健康检查不反映实际系统状态

## Proposed Solution

### Phase 1: 认证系统修复 (P0)

- 实现邮件服务集成（支持SMTP/SendGrid）
- 完成密码重置流程端到端

### Phase 2: 管理后台修复 (P0)

- 实现或移除内容质量检查存根端点
- 明确功能边界，避免误导管理员

### Phase 3: 后端服务修复 (P0)

- 修复AMAS历史端点
- 修复StorageService userId处理
- 修复洞察生成分群过滤

## Scope

### In Scope

- 8个P0严重问题的完整修复
- 相关单元测试和集成测试
- 必要的数据库迁移
- 配置文档更新

### Out of Scope

- P1/P2/P3级别问题（将在后续提案中处理）
- UI/UX重新设计
- 性能优化

## Dependencies

- 邮件服务提供商选择（SMTP或SendGrid）
- 环境变量配置
- 数据库迁移执行权限

## Risks

| Risk               | Mitigation                              |
| ------------------ | --------------------------------------- |
| 邮件服务集成复杂度 | 使用成熟的邮件库，提供SMTP和API两种模式 |
| 现有功能回归       | 完整的测试覆盖，分阶段部署              |
| 配置泄露           | 敏感信息通过环境变量管理                |

## Success Criteria

1. 用户可以通过"忘记密码"流程自助重置密码
2. 管理员内容质量检查界面显示真实数据或明确的"未实现"状态
3. 所有被标记为broken的端点返回正确数据
4. 健康检查反映实际服务连接状态
