# CLAUDE.md 开发准则

## 概览

本文件指导当前仓库内的全部开发与文档工作，确保输出遵循强制性标准并保持可审计性。

**语言规范**
- **强制使用简体中文**：所有回复、文档、注释、日志、提交信息必须使用简体中文
- 唯一例外：代码标识符遵循项目既有命名约定

**上下文要求**
- 编码前至少分析 3 个现有实现，识别可复用的接口与约束
- 确认输入输出协议、配置与环境需求
- 弄清测试框架、命名约定和格式化规则

## 核心原则

### 架构优先级
- **标准化 + 生态复用**拥有最高优先级
- 首先查找并复用官方 SDK、社区成熟方案或既有模块
- 禁止新增自研方案，除非已有实践无法满足需求
- 对偏离标准的实现，必须规划替换时间表

### 设计原则
- 严格遵循 SOLID、DRY 与关注点分离
- 依赖倒置与接口隔离优先
- 遇到复杂逻辑必须先拆分职责，再进入编码

### 简单性定义
- 每个函数或类仅承担单一责任
- 禁止过早抽象；重复三次以上再考虑通用化
- 禁止"聪明"技巧，以可读性为先
- 如果需要额外解释，说明实现仍然过于复杂

## 代码质量标准

### 注释规范
- 使用 UTF-8 无 BOM 编码
- 注释描述意图、约束与使用方式，而非重复代码逻辑
- 禁止"修改说明"式注释，变更信息由版本控制承担
- 注释简洁明了，直指核心要点

### 实现标准
- 禁止 MVP、最小实现或占位符；提交前必须完成全量功能
- 主动删除过时、重复或逃生式代码
- 遵守编程语言标准代码风格和项目既有风格规范
- 破坏性改动提供迁移步骤或回滚方案
- 遵循最佳实践，确保代码质量和可维护性

### 性能意识
- 评估时间复杂度、内存占用与 I/O 影响
- 识别潜在瓶颈后提供监测或优化建议
- 禁止引入未经评估的昂贵依赖或阻塞操作

### 测试规范
- 每次实现必须提供可自动运行的测试
- 测试覆盖正常流程、边界条件与错误恢复
- 缺失测试必须在文档中列为风险并给出补测计划

## 工作流程

### 总原则
- **深度思考优先**：任何时候必须先梳理问题再动手
- 非必要问题不询问用户，自动连续执行
- 问题驱动优先于流程驱动，追求充分性而非完整性

### 五阶段模式
1. **研究**：阅读材料、厘清约束，禁止编码
2. **计划**：制定详细计划与成功标准
3. **实施**：根据计划执行并保持小步提交
4. **验证**：运行测试，记录结果
5. **提交**：准备交付文档与迁移/回滚方案

### 编码前检索清单

**必须完成以下检查：**

1. **文件搜索**：找到 5-10 个候选文件
2. **内容搜索**：找到关键实现位置
3. **阅读相似实现**：至少 3 个相关文件
4. **测试代码分析**：理解测试策略和覆盖标准
5. **模式提取**：生成项目模式清单

**检索强度分级：**
- 简单任务（单文件、<50行）：步骤 1-3
- 中等任务（多文件、<200行）：完整 5 步
- 复杂任务（架构级、>200行）：完整 5 步 + 增强验证

### 上下文充分性验证

编码前必须回答以下问题（全部为"是"才能继续）：

1. 能说出至少 3 个相似实现的文件路径？
2. 理解项目中这类功能的实现模式？
3. 知道项目中有哪些可复用的工具函数/类？
4. 理解项目的命名约定和代码风格？
5. 知道如何测试这个功能？
6. 确认没有重复造轮子？
7. 理解这个功能的依赖和集成点？

**任一项为"否" → 返回检索阶段**

## 验证机制

### 强制验证
- 每次改动必须提供可重复的本地验证步骤
- 验证失败时立即终止提交
- 无法验证的部分必须先补足验证能力或退回任务

### 质量审查
- 输出技术维度评分（代码质量、测试覆盖、规范遵循）
- 输出战略维度评分（需求匹配、架构一致、风险评估）
- 综合评分（0-100）和建议（通过/退回/需讨论）

**决策规则：**
- ≥90分 且 "通过" → 确认通过
- <80分 且 "退回" → 确认退回
- 80-89分 → 仔细审阅后决策

## 懒惰检测机制

**核心原则**：研究先于编码，复用优于创造，一致性优于个人偏好

### 编码前检测
必须记录以下检查：
- 已查阅上下文摘要
- 将使用的可复用组件
- 将遵循的命名约定和代码风格
- 确认不重复造轮子

**无法回答任一项 → 立即终止，返回检索阶段**

### 编码后验证
必须声明：
- 复用了哪些既有组件
- 遵循了哪些项目约定
- 对比了哪些相似实现
- 未重复造轮子的证明

**三级惩罚：**
- Level 1：警告，立即修正
- Level 2：强制退回检索阶段
- Level 3：任务失败，需用户介入

## 文件结构

工作文件写入项目本地 `.claude/` 目录：
```
<project>/.claude/
    ├── context-summary-[任务名].md   ← 上下文摘要
    ├── operations-log.md             ← 决策和操作记录
    └── verification-report.md        ← 验证报告
```

## 上下文摘要模板

```markdown
## 项目上下文摘要（[任务名称]）
生成时间：[YYYY-MM-DD HH:mm:ss]

### 相似实现分析
- 实现1: [路径] - 模式、可复用组件、注意事项
- 实现2: [路径] - 模式、可复用组件、注意事项

### 项目约定
- 命名约定: [规则]
- 文件组织: [结构]
- 代码风格: [规范]

### 可复用组件
- [路径]: [用途]

### 测试策略
- 测试框架: [名称]
- 覆盖要求: [标准]

### 依赖和集成点
- 外部依赖: [列表]
- 内部依赖: [关系]

### 关键风险点
- 并发问题: [描述]
- 边界条件: [描述]
- 性能瓶颈: [描述]
```

## 开发哲学

- 坚持渐进式迭代，保持每次改动可编译、可验证
- 实现前研读既有代码或文档，吸收现有经验
- 保持务实态度，优先满足真实需求而非理想化设计
- 选择表达清晰的实现，拒绝炫技式写法
- 偏向简单方案，避免过度架构或早期优化
- 遵循既有代码风格，包括导入顺序、命名与格式化

## 项目集成规则

### 学习代码库
- 寻找至少 3 个相似特性或组件，理解其设计与复用方式
- 识别项目中通用模式与约定，在新实现中沿用
- 优先使用既有库、工具或辅助函数
- 遵循既有测试编排，沿用断言与夹具结构

### 工具使用
- 使用项目现有构建系统，不得私自新增脚本
- 使用项目既定的测试框架与运行方式
- 使用项目的格式化/静态检查设置

## 重要提醒

**绝对禁止：**
- 在缺乏证据的情况下做出假设

**必须做到：**
- 实现复杂任务前完成详尽规划
- 跨模块或超过 5 个子任务的工作生成任务分解
- 复杂任务维护 TODO 清单并及时更新
- 开始开发前校验规划文档
- 保持小步交付，确保每次提交可用
- 执行过程中同步更新计划文档
- 主动学习既有实现的优缺点
- 连续三次失败后暂停，重新评估策略

## 内容唯一性规则

- 每一层级自洽掌握自身抽象范围，禁止跨层混用
- 引用其他层的资料而非复制粘贴，保持信息唯一来源
- 每一层级站在对应视角描述系统，避免越位细节
- 禁止在高层文档中堆叠实现细节
