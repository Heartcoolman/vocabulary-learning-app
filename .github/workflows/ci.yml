name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

# 取消之前运行的相同工作流
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.24.0'
  RUST_VERSION: 'stable'
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # 代码检查 (Lint & Format)
  # ============================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Check Prettier formatting
        run: pnpm format:check

  # ============================================
  # TypeScript 类型检查
  # ============================================
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Clean and Build Shared Package
        run: |
          rm -rf packages/shared/dist packages/shared/tsconfig.tsbuildinfo
          pnpm --filter @danci/shared build

      - name: Run TypeScript check (Frontend)
        run: pnpm --filter @danci/frontend exec tsc --noEmit

  # ============================================
  # Rust 检查 (Native + Backend)
  # ============================================
  rust:
    name: Rust Check & Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:latest-pg15
        env:
          POSTGRES_USER: danci
          POSTGRES_PASSWORD: danci_test
          POSTGRES_DB: danci_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            packages/native/target/
            packages/backend-rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features postgres || true

      - name: Initialize Database Schema
        env:
          PGPASSWORD: danci_test
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if pg_isready -h localhost -U danci -d danci_test; then
              break
            fi
            sleep 1
          done
          for sql_file in packages/backend-rust/sql/*.sql; do
            # Skip SQLite-specific schema file
            if [[ "$sql_file" == *"sqlite"* ]]; then
              continue
            fi
            psql -h localhost -U danci -d danci_test -f "$sql_file" || true
          done

      - name: SQLx Prepare Check
        working-directory: packages/backend-rust
        env:
          DATABASE_URL: postgres://danci:danci_test@localhost:5432/danci_test
        run: cargo sqlx prepare --check -- --bin danci-backend-rust || echo "::warning::SQLx prepare check failed - .sqlx/ may need regeneration"

      - name: Check Native Package (no napi)
        working-directory: packages/native
        run: cargo check --no-default-features

      - name: Check Native Package (with napi)
        working-directory: packages/native
        run: cargo check --features napi

      - name: Run Native Tests
        working-directory: packages/native
        run: cargo test --no-default-features

      - name: Validate SQL Migrations
        working-directory: packages/backend-rust
        run: ./scripts/validate-migrations.sh

      - name: Check Backend Rust
        working-directory: packages/backend-rust
        run: cargo check

      - name: Run Backend Unit Tests
        working-directory: packages/backend-rust
        run: cargo test --lib

      - name: Run Backend Integration Tests
        working-directory: packages/backend-rust
        run: cargo test --test '*'

      - name: Clippy Lint (Native)
        working-directory: packages/native
        run: cargo clippy --no-default-features -- -D warnings
        continue-on-error: true

      - name: Clippy Lint (Backend)
        working-directory: packages/backend-rust
        run: cargo clippy -- -D warnings
        continue-on-error: true

      - name: Check Rust Format
        run: |
          cd packages/native && cargo fmt --check
          cd ../backend-rust && cargo fmt --check

  # ============================================
  # 单元测试 (Unit Tests)
  # ============================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Shared Package
        run: pnpm --filter @danci/shared build

      - name: Run Frontend Tests with Coverage
        run: pnpm --filter @danci/frontend test:coverage

      - name: Run Shared Tests with Coverage
        run: pnpm --filter @danci/shared test:coverage
        continue-on-error: true

      - name: Upload Frontend Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-frontend
          path: packages/frontend/coverage/
          retention-days: 7

  # ============================================
  # 测试覆盖率检查
  # ============================================
  coverage-check:
    name: Coverage Threshold Check
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Frontend Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-frontend
          path: coverage/frontend

      - name: Check Frontend Coverage Threshold
        run: |
          if [ -f coverage/frontend/coverage-summary.json ]; then
            LINES=$(cat coverage/frontend/coverage-summary.json | jq '.total.lines.pct')
            STATEMENTS=$(cat coverage/frontend/coverage-summary.json | jq '.total.statements.pct')
            FUNCTIONS=$(cat coverage/frontend/coverage-summary.json | jq '.total.functions.pct')
            BRANCHES=$(cat coverage/frontend/coverage-summary.json | jq '.total.branches.pct')

            echo "## Frontend Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Coverage | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|-----------|--------|" >> $GITHUB_STEP_SUMMARY

            # 当前阈值设为 45%（略低于当前覆盖率），后续逐步提高
            THRESHOLD=45

            check_coverage() {
              local name=$1
              local value=$2
              local status="✅"
              if (( $(echo "$value < $THRESHOLD" | bc -l) )); then
                status="❌"
              fi
              echo "| $name | ${value}% | ${THRESHOLD}% | $status |" >> $GITHUB_STEP_SUMMARY
            }

            check_coverage "Lines" "$LINES"
            check_coverage "Statements" "$STATEMENTS"
            check_coverage "Functions" "$FUNCTIONS"
            check_coverage "Branches" "$BRANCHES"

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Target:** Gradually increase to 60% → 70% → 80%" >> $GITHUB_STEP_SUMMARY

            # 如果任何指标低于阈值，发出警告但不失败
            if (( $(echo "$LINES < $THRESHOLD" | bc -l) )); then
              echo "::warning::Frontend line coverage ($LINES%) is below threshold ($THRESHOLD%)"
            fi
          else
            echo "::warning::Frontend coverage report not found"
          fi

  # ============================================
  # 构建验证
  # ============================================
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Cache Turbo build
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Upload Frontend Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: packages/frontend/dist/
          retention-days: 7

  # ============================================
  # E2E 测试
  # ============================================
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build, rust]
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: danci
          POSTGRES_PASSWORD: danci_test
          POSTGRES_DB: danci_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            packages/backend-rust/target/
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-
            ${{ runner.os }}-cargo-

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Build Backend
        working-directory: packages/backend-rust
        run: cargo build --release

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: packages/frontend/dist/

      - name: Initialize Database Schema
        env:
          PGPASSWORD: danci_test
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if pg_isready -h localhost -U danci -d danci_test; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 1
          done

          echo "Executing SQL migrations..."
          for sql_file in packages/backend-rust/sql/[0-9]*.sql; do
            echo "Executing: $(basename $sql_file)"
            psql -h localhost -U danci -d danci_test -f "$sql_file" -v ON_ERROR_STOP=1
          done

          echo "Verifying tables exist..."
          psql -h localhost -U danci -d danci_test -c "SELECT tablename FROM pg_tables WHERE schemaname = 'public';"

      - name: Run E2E Tests
        run: pnpm test:e2e
        env:
          DATABASE_URL: postgres://danci:danci_test@localhost:5432/danci_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_for_e2e
          E2E_FRONTEND_URL: http://localhost:5173
          E2E_BACKEND_URL: http://localhost:3000
          CI: true
        continue-on-error: true

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  # ============================================
  # PR 状态总结
  # ============================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, typecheck, rust, test, build, coverage-check, e2e]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "## CI Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          add_status() {
            local name=$1
            local result=$2
            local status="✅ Passed"
            if [ "$result" == "failure" ]; then
              status="❌ Failed"
            elif [ "$result" == "skipped" ]; then
              status="⏭️ Skipped"
            elif [ "$result" == "cancelled" ]; then
              status="🚫 Cancelled"
            fi
            echo "| $name | $status |" >> $GITHUB_STEP_SUMMARY
          }

          add_status "Lint & Format" "${{ needs.lint.result }}"
          add_status "TypeScript" "${{ needs.typecheck.result }}"
          add_status "Rust" "${{ needs.rust.result }}"
          add_status "Unit Tests" "${{ needs.test.result }}"
          add_status "Build" "${{ needs.build.result }}"
          add_status "Coverage" "${{ needs.coverage-check.result }}"
          add_status "E2E Tests" "${{ needs.e2e.result }}"

          # 核心检查失败则整体失败
          if [ "${{ needs.lint.result }}" == "failure" ]; then
            echo "::error::Lint check failed"
            exit 1
          fi
          if [ "${{ needs.typecheck.result }}" == "failure" ]; then
            echo "::error::TypeScript check failed"
            exit 1
          fi
          if [ "${{ needs.rust.result }}" == "failure" ]; then
            echo "::error::Rust check failed"
            exit 1
          fi
          if [ "${{ needs.test.result }}" == "failure" ]; then
            echo "::error::Tests failed"
            exit 1
          fi
          if [ "${{ needs.build.result }}" == "failure" ]; then
            echo "::error::Build failed"
            exit 1
          fi

          # E2E 测试失败只警告，不阻断（因为可能有环境问题）
          if [ "${{ needs.e2e.result }}" == "failure" ]; then
            echo "::warning::E2E tests failed - please review the Playwright report"
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All core CI checks passed!**" >> $GITHUB_STEP_SUMMARY
