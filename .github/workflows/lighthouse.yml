name: Lighthouse CI

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'packages/frontend/**'
      - 'lighthouserc.js'
      - '.github/workflows/lighthouse.yml'
  push:
    branches: [main, master]
    paths:
      - 'packages/frontend/**'
      - 'lighthouserc.js'
  workflow_dispatch:

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @danci/shared build

      - name: Build frontend
        run: pnpm --filter @danci/frontend build
        env:
          NODE_ENV: production

      - name: Run Lighthouse CI
        id: lighthouse
        working-directory: packages/frontend
        run: |
          # Start preview server in background
          pnpm preview --port 4173 &
          SERVER_PID=$!

          # Wait for server to be ready
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:4173 > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            sleep 1
          done

          # Run Lighthouse
          npx @lhci/cli@0.13.x autorun --config=../../lighthouserc.js 2>&1 | tee lighthouse-output.txt || true

          # Extract scores from manifest
          if [ -f "../../.lighthouseci/manifest.json" ]; then
            performance=$(cat ../../.lighthouseci/manifest.json | jq -r '.[0].summary.performance // 0')
            accessibility=$(cat ../../.lighthouseci/manifest.json | jq -r '.[0].summary.accessibility // 0')
            best_practices=$(cat ../../.lighthouseci/manifest.json | jq -r '.[0].summary."best-practices" // 0')
            seo=$(cat ../../.lighthouseci/manifest.json | jq -r '.[0].summary.seo // 0')

            echo "performance=$performance" >> $GITHUB_OUTPUT
            echo "accessibility=$accessibility" >> $GITHUB_OUTPUT
            echo "best_practices=$best_practices" >> $GITHUB_OUTPUT
            echo "seo=$seo" >> $GITHUB_OUTPUT
          else
            echo "performance=0" >> $GITHUB_OUTPUT
            echo "accessibility=0" >> $GITHUB_OUTPUT
            echo "best_practices=0" >> $GITHUB_OUTPUT
            echo "seo=0" >> $GITHUB_OUTPUT
          fi

          # Cleanup
          kill $SERVER_PID 2>/dev/null || true

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 30
        if: always()

      - name: Format Lighthouse Score
        id: format_score
        run: |
          # Get raw scores with defaults
          perf_raw="${{ steps.lighthouse.outputs.performance }}"
          a11y_raw="${{ steps.lighthouse.outputs.accessibility }}"
          bp_raw="${{ steps.lighthouse.outputs.best_practices }}"
          seo_raw="${{ steps.lighthouse.outputs.seo }}"

          # Default to 0 if empty
          perf_raw=${perf_raw:-0}
          a11y_raw=${a11y_raw:-0}
          bp_raw=${bp_raw:-0}
          seo_raw=${seo_raw:-0}

          # Convert to percentage (handle empty/invalid values)
          to_percent() {
            local val="$1"
            if [ -z "$val" ] || [ "$val" = "0" ] || [ "$val" = "null" ]; then
              echo "0"
            else
              echo "$val * 100" | bc -l 2>/dev/null | xargs printf "%.0f" 2>/dev/null || echo "0"
            fi
          }

          perf=$(to_percent "$perf_raw")
          a11y=$(to_percent "$a11y_raw")
          bp=$(to_percent "$bp_raw")
          seo=$(to_percent "$seo_raw")

          echo "perf_score=$perf" >> $GITHUB_OUTPUT
          echo "a11y_score=$a11y" >> $GITHUB_OUTPUT
          echo "bp_score=$bp" >> $GITHUB_OUTPUT
          echo "seo_score=$seo" >> $GITHUB_OUTPUT
        if: always()

      - name: Comment PR with Lighthouse Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const perfScore = '${{ steps.format_score.outputs.perf_score }}' || '0';
            const a11yScore = '${{ steps.format_score.outputs.a11y_score }}' || '0';
            const bpScore = '${{ steps.format_score.outputs.bp_score }}' || '0';
            const seoScore = '${{ steps.format_score.outputs.seo_score }}' || '0';

            const getEmoji = (score) => {
              const s = parseInt(score) || 0;
              if (s >= 90) return 'ğŸŸ¢';
              if (s >= 50) return 'ğŸŸ ';
              return 'ğŸ”´';
            };

            const body = `## ğŸ  Lighthouse æ€§èƒ½æŠ¥å‘Š

            | æŒ‡æ ‡ | åˆ†æ•° | çŠ¶æ€ |
            |------|------|------|
            | âš¡ æ€§èƒ½ (Performance) | **${perfScore}** | ${getEmoji(perfScore)} |
            | â™¿ å¯è®¿é—®æ€§ (Accessibility) | **${a11yScore}** | ${getEmoji(a11yScore)} |
            | âœ… æœ€ä½³å®è·µ (Best Practices) | **${bpScore}** | ${getEmoji(bpScore)} |
            | ğŸ” SEO | **${seoScore}** | ${getEmoji(seoScore)} |

            ğŸ“Š [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Lighthouse æ€§èƒ½æŠ¥å‘Š')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check Performance Regression
        if: always()
        run: |
          echo "æ£€æŸ¥æ€§èƒ½é€€åŒ–..."

          perf="${{ steps.format_score.outputs.perf_score }}"
          a11y="${{ steps.format_score.outputs.a11y_score }}"
          bp="${{ steps.format_score.outputs.bp_score }}"
          seo="${{ steps.format_score.outputs.seo_score }}"

          # Default to 0 if empty
          perf=${perf:-0}
          a11y=${a11y:-0}
          bp=${bp:-0}
          seo=${seo:-0}

          # Performance thresholds
          PERF_THRESHOLD=80
          A11Y_THRESHOLD=90
          BP_THRESHOLD=85
          SEO_THRESHOLD=90

          has_regression=false

          if [ "$perf" -lt "$PERF_THRESHOLD" ]; then
            echo "::warning::âš ï¸ æ€§èƒ½åˆ†æ•° ($perf) ä½äºé˜ˆå€¼ ($PERF_THRESHOLD)"
            has_regression=true
          fi

          if [ "$a11y" -lt "$A11Y_THRESHOLD" ]; then
            echo "::warning::âš ï¸ å¯è®¿é—®æ€§åˆ†æ•° ($a11y) ä½äºé˜ˆå€¼ ($A11Y_THRESHOLD)"
            has_regression=true
          fi

          if [ "$bp" -lt "$BP_THRESHOLD" ]; then
            echo "::warning::âš ï¸ æœ€ä½³å®è·µåˆ†æ•° ($bp) ä½äºé˜ˆå€¼ ($BP_THRESHOLD)"
            has_regression=true
          fi

          if [ "$seo" -lt "$SEO_THRESHOLD" ]; then
            echo "::warning::âš ï¸ SEO åˆ†æ•° ($seo) ä½äºé˜ˆå€¼ ($SEO_THRESHOLD)"
            has_regression=true
          fi

          if [ "$has_regression" = true ]; then
            echo "::warning::æ€§èƒ½æŒ‡æ ‡ä½äºé˜ˆå€¼ï¼Œè¯·æ£€æŸ¥å¹¶ä¼˜åŒ–ã€‚"
          else
            echo "âœ… æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡éƒ½åœ¨é˜ˆå€¼èŒƒå›´å†…ï¼"
          fi
        continue-on-error: true

      - name: Performance Summary
        if: always()
        run: |
          echo "ğŸ“Š Lighthouse æ€§èƒ½æ‘˜è¦"
          echo "========================"
          echo "æ€§èƒ½åˆ†æ•°: ${{ steps.format_score.outputs.perf_score }}"
          echo "å¯è®¿é—®æ€§: ${{ steps.format_score.outputs.a11y_score }}"
          echo "æœ€ä½³å®è·µ: ${{ steps.format_score.outputs.bp_score }}"
          echo "SEO: ${{ steps.format_score.outputs.seo_score }}"
          echo "========================"
