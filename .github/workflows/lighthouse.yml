name: Lighthouse CI

on:
  pull_request:
    branches: [main, master, develop, dev]
    paths:
      - 'packages/frontend/**'
      - 'lighthouserc.js'
      - '.github/workflows/lighthouse.yml'
  push:
    branches: [main, master]
    paths:
      - 'packages/frontend/**'
      - 'lighthouserc.js'
  workflow_dispatch:

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @danci/shared build

      - name: Build frontend
        run: pnpm --filter @danci/frontend build
        env:
          NODE_ENV: production

      - name: Verify build output
        working-directory: packages/frontend
        run: |
          echo "Checking build output..."
          if [ -d "dist" ]; then
            echo "dist directory exists"
            ls -la dist/
          else
            echo "ERROR: dist directory not found!"
            exit 1
          fi

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Run Lighthouse CI
        id: lighthouse
        working-directory: packages/frontend
        run: |
          # Install lhci globally
          npm install -g @lhci/cli@0.13.x

          # Start preview server in background
          echo "Starting preview server..."
          pnpm preview --port 4173 &
          SERVER_PID=$!

          # Wait for server to be ready
          echo "Waiting for server to start on http://localhost:4173..."
          server_ready=false
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:4173 | grep -q "200"; then
              echo "Server is ready! (attempt $i)"
              server_ready=true
              break
            fi
            echo "Waiting... (attempt $i)"
            sleep 1
          done

          if [ "$server_ready" = false ]; then
            echo "ERROR: Server failed to start within 60 seconds"
            echo "Checking if process is running..."
            ps aux | grep -i preview || true
            echo "Trying to curl the server..."
            curl -v http://localhost:4173 || true
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          # Create a simple lighthouse config for CI (without startServerCommand since we start it manually)
          cat > /tmp/lhci-config.js << 'LHCI_EOF'
          module.exports = {
            ci: {
              collect: {
                numberOfRuns: 1,
                url: ['http://localhost:4173'],
                settings: {
                  preset: 'desktop',
                  onlyCategories: ['performance', 'accessibility', 'best-practices', 'seo'],
                  chromeFlags: '--no-sandbox --headless --disable-gpu --disable-dev-shm-usage',
                  skipAudits: ['uses-http2'],
                },
              },
              upload: {
                target: 'temporary-public-storage',
              },
            },
          };
          LHCI_EOF

          # Run Lighthouse
          echo "Running Lighthouse CI..."
          lhci autorun --config=/tmp/lhci-config.js 2>&1 | tee lighthouse-output.txt
          lhci_exit_code=${PIPESTATUS[0]}
          echo "LHCI exit code: $lhci_exit_code"

          # Check for manifest file
          echo "Looking for manifest file..."
          find . -name "manifest.json" -type f 2>/dev/null || true
          ls -la .lighthouseci/ 2>/dev/null || echo "No .lighthouseci directory in current dir"
          ls -la ../../.lighthouseci/ 2>/dev/null || echo "No .lighthouseci directory in root"

          # Extract scores from manifest (check multiple locations)
          manifest_file=""
          if [ -f ".lighthouseci/manifest.json" ]; then
            manifest_file=".lighthouseci/manifest.json"
          elif [ -f "../../.lighthouseci/manifest.json" ]; then
            manifest_file="../../.lighthouseci/manifest.json"
          fi

          if [ -n "$manifest_file" ]; then
            echo "Found manifest at: $manifest_file"
            cat "$manifest_file"
            performance=$(cat "$manifest_file" | jq -r '.[0].summary.performance // 0')
            accessibility=$(cat "$manifest_file" | jq -r '.[0].summary.accessibility // 0')
            best_practices=$(cat "$manifest_file" | jq -r '.[0].summary."best-practices" // 0')
            seo=$(cat "$manifest_file" | jq -r '.[0].summary.seo // 0')

            echo "Raw scores: perf=$performance, a11y=$accessibility, bp=$best_practices, seo=$seo"

            echo "performance=$performance" >> $GITHUB_OUTPUT
            echo "accessibility=$accessibility" >> $GITHUB_OUTPUT
            echo "best_practices=$best_practices" >> $GITHUB_OUTPUT
            echo "seo=$seo" >> $GITHUB_OUTPUT
          else
            echo "WARNING: No manifest.json found"
            echo "Lighthouse output:"
            cat lighthouse-output.txt || true
            echo "performance=0" >> $GITHUB_OUTPUT
            echo "accessibility=0" >> $GITHUB_OUTPUT
            echo "best_practices=0" >> $GITHUB_OUTPUT
            echo "seo=0" >> $GITHUB_OUTPUT
          fi

          # Cleanup
          kill $SERVER_PID 2>/dev/null || true
        continue-on-error: true

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: |
            packages/frontend/.lighthouseci/
            .lighthouseci/
          retention-days: 30
        if: always()
        continue-on-error: true

      - name: Format Lighthouse Score
        id: format_score
        run: |
          perf_raw="${{ steps.lighthouse.outputs.performance }}"
          a11y_raw="${{ steps.lighthouse.outputs.accessibility }}"
          bp_raw="${{ steps.lighthouse.outputs.best_practices }}"
          seo_raw="${{ steps.lighthouse.outputs.seo }}"

          perf_raw=${perf_raw:-0}
          a11y_raw=${a11y_raw:-0}
          bp_raw=${bp_raw:-0}
          seo_raw=${seo_raw:-0}

          to_percent() {
            local val="$1"
            if [ -z "$val" ] || [ "$val" = "0" ] || [ "$val" = "null" ]; then
              echo "0"
            else
              result=$(echo "$val * 100" | bc -l 2>/dev/null | xargs printf "%.0f" 2>/dev/null) || result="0"
              echo "$result"
            fi
          }

          perf=$(to_percent "$perf_raw")
          a11y=$(to_percent "$a11y_raw")
          bp=$(to_percent "$bp_raw")
          seo=$(to_percent "$seo_raw")

          echo "Formatted scores: perf=$perf, a11y=$a11y, bp=$bp, seo=$seo"

          echo "perf_score=$perf" >> $GITHUB_OUTPUT
          echo "a11y_score=$a11y" >> $GITHUB_OUTPUT
          echo "bp_score=$bp" >> $GITHUB_OUTPUT
          echo "seo_score=$seo" >> $GITHUB_OUTPUT
        if: always()

      - name: Comment PR with Lighthouse Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        continue-on-error: true
        with:
          script: |
            const perfScore = '${{ steps.format_score.outputs.perf_score }}' || '0';
            const a11yScore = '${{ steps.format_score.outputs.a11y_score }}' || '0';
            const bpScore = '${{ steps.format_score.outputs.bp_score }}' || '0';
            const seoScore = '${{ steps.format_score.outputs.seo_score }}' || '0';

            const getEmoji = (score) => {
              const s = parseInt(score) || 0;
              if (s >= 90) return 'ğŸŸ¢';
              if (s >= 50) return 'ğŸŸ ';
              return 'ğŸ”´';
            };

            const body = `## ğŸ  Lighthouse æ€§èƒ½æŠ¥å‘Š

            | æŒ‡æ ‡ | åˆ†æ•° | çŠ¶æ€ |
            |------|------|------|
            | âš¡ æ€§èƒ½ (Performance) | **${perfScore}** | ${getEmoji(perfScore)} |
            | â™¿ å¯è®¿é—®æ€§ (Accessibility) | **${a11yScore}** | ${getEmoji(a11yScore)} |
            | âœ… æœ€ä½³å®è·µ (Best Practices) | **${bpScore}** | ${getEmoji(bpScore)} |
            | ğŸ” SEO | **${seoScore}** | ${getEmoji(seoScore)} |

            ğŸ“Š [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('Lighthouse æ€§èƒ½æŠ¥å‘Š')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            } catch (e) {
              console.log('Failed to comment on PR:', e.message);
            }

      - name: Performance Summary
        if: always()
        run: |
          echo "ğŸ“Š Lighthouse æ€§èƒ½æ‘˜è¦"
          echo "========================"
          echo "æ€§èƒ½åˆ†æ•°: ${{ steps.format_score.outputs.perf_score }}"
          echo "å¯è®¿é—®æ€§: ${{ steps.format_score.outputs.a11y_score }}"
          echo "æœ€ä½³å®è·µ: ${{ steps.format_score.outputs.bp_score }}"
          echo "SEO: ${{ steps.format_score.outputs.seo_score }}"
          echo "========================"

          perf="${{ steps.format_score.outputs.perf_score }}"
          perf=${perf:-0}

          if [ "$perf" -eq 0 ]; then
            echo "::warning::Lighthouse æœªèƒ½è·å–æœ‰æ•ˆåˆ†æ•°ï¼Œè¯·æ£€æŸ¥æ„å»ºå’ŒæœåŠ¡å™¨é…ç½®"
          elif [ "$perf" -lt 50 ]; then
            echo "::warning::æ€§èƒ½åˆ†æ•°è¾ƒä½ ($perf)ï¼Œå»ºè®®ä¼˜åŒ–"
          else
            echo "âœ… Lighthouse å®¡è®¡å®Œæˆ"
          fi
