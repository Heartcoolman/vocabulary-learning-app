name: Lighthouse CI

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'packages/frontend/**'
      - 'lighthouserc.js'
      - '.github/workflows/lighthouse.yml'
  push:
    branches: [main, master]
    paths:
      - 'packages/frontend/**'
      - 'lighthouserc.js'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm --filter frontend build
        env:
          NODE_ENV: production

      - name: Run Lighthouse CI
        id: lighthouse
        run: |
          pnpm lhci autorun --config=lighthouserc.js 2>&1 | tee lighthouse-output.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          # æå–æ€§èƒ½åˆ†æ•°
          if [ -f ".lighthouseci/manifest.json" ]; then
            performance=$(cat .lighthouseci/manifest.json | jq -r '.[0].summary.performance // 0')
            accessibility=$(cat .lighthouseci/manifest.json | jq -r '.[0].summary.accessibility // 0')
            best_practices=$(cat .lighthouseci/manifest.json | jq -r '.[0].summary."best-practices" // 0')
            seo=$(cat .lighthouseci/manifest.json | jq -r '.[0].summary.seo // 0')

            echo "performance=$performance" >> $GITHUB_OUTPUT
            echo "accessibility=$accessibility" >> $GITHUB_OUTPUT
            echo "best_practices=$best_practices" >> $GITHUB_OUTPUT
            echo "seo=$seo" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v6
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 30
        if: always()

      - name: Format Lighthouse Score
        id: format_score
        run: |
          # è½¬æ¢åˆ†æ•°ä¸ºç™¾åˆ†æ¯”
          perf=$(echo "${{ steps.lighthouse.outputs.performance }} * 100" | bc -l | xargs printf "%.0f")
          a11y=$(echo "${{ steps.lighthouse.outputs.accessibility }} * 100" | bc -l | xargs printf "%.0f")
          bp=$(echo "${{ steps.lighthouse.outputs.best_practices }} * 100" | bc -l | xargs printf "%.0f")
          seo=$(echo "${{ steps.lighthouse.outputs.seo }} * 100" | bc -l | xargs printf "%.0f")

          # ç¡®å®šåˆ†æ•°é¢œè‰²
          get_color() {
            score=$1
            if [ "$score" -ge 90 ]; then echo "green";
            elif [ "$score" -ge 50 ]; then echo "orange";
            else echo "red"; fi
          }

          get_emoji() {
            score=$1
            if [ "$score" -ge 90 ]; then echo ":white_check_mark:";
            elif [ "$score" -ge 50 ]; then echo ":warning:";
            else echo ":x:"; fi
          }

          perf_emoji=$(get_emoji $perf)
          a11y_emoji=$(get_emoji $a11y)
          bp_emoji=$(get_emoji $bp)
          seo_emoji=$(get_emoji $seo)

          echo "perf_score=$perf" >> $GITHUB_OUTPUT
          echo "a11y_score=$a11y" >> $GITHUB_OUTPUT
          echo "bp_score=$bp" >> $GITHUB_OUTPUT
          echo "seo_score=$seo" >> $GITHUB_OUTPUT
          echo "perf_emoji=$perf_emoji" >> $GITHUB_OUTPUT
          echo "a11y_emoji=$a11y_emoji" >> $GITHUB_OUTPUT
          echo "bp_emoji=$bp_emoji" >> $GITHUB_OUTPUT
          echo "seo_emoji=$seo_emoji" >> $GITHUB_OUTPUT
        if: always()

      - name: Comment PR with Lighthouse Results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const perfScore = '${{ steps.format_score.outputs.perf_score }}';
            const a11yScore = '${{ steps.format_score.outputs.a11y_score }}';
            const bpScore = '${{ steps.format_score.outputs.bp_score }}';
            const seoScore = '${{ steps.format_score.outputs.seo_score }}';

            const getEmoji = (score) => {
              const s = parseInt(score);
              if (s >= 90) return 'ğŸŸ¢';
              if (s >= 50) return 'ğŸŸ ';
              return 'ğŸ”´';
            };

            const exitCode = '${{ steps.lighthouse.outputs.exit_code }}';
            const status = exitCode === '0' ? 'âœ… é€šè¿‡' : 'âŒ æœªé€šè¿‡';

            const body = `## ğŸ  Lighthouse æ€§èƒ½æŠ¥å‘Š

            | æŒ‡æ ‡ | åˆ†æ•° | çŠ¶æ€ |
            |------|------|------|
            | âš¡ æ€§èƒ½ (Performance) | **${perfScore}** | ${getEmoji(perfScore)} |
            | â™¿ å¯è®¿é—®æ€§ (Accessibility) | **${a11yScore}** | ${getEmoji(a11yScore)} |
            | âœ… æœ€ä½³å®è·µ (Best Practices) | **${bpScore}** | ${getEmoji(bpScore)} |
            | ğŸ” SEO | **${seoScore}** | ${getEmoji(seoScore)} |

            ### æ€§èƒ½é˜ˆå€¼
            | æŒ‡æ ‡ | é˜ˆå€¼ |
            |------|------|
            | Bundle å¤§å° | < 450KB |
            | é¦–å±åŠ è½½ (FCP) | < 1.8s |
            | å¯äº¤äº’æ—¶é—´ (TTI) | < 3s |
            | æœ€å¤§å†…å®¹ç»˜åˆ¶ (LCP) | < 2.5s |
            | ç´¯ç§¯å¸ƒå±€åç§» (CLS) | < 0.1 |

            **çŠ¶æ€**: ${status}

            ğŸ“Š [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            <details>
            <summary>ğŸ“ åˆ†æ•°è¯´æ˜</summary>

            - ğŸŸ¢ **90-100**: ä¼˜ç§€
            - ğŸŸ  **50-89**: éœ€è¦æ”¹è¿›
            - ğŸ”´ **0-49**: æ€§èƒ½è¾ƒå·®

            </details>
            `;

            // æŸ¥æ‰¾å¹¶æ›´æ–°å·²æœ‰è¯„è®ºï¼Œæˆ–åˆ›å»ºæ–°è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Lighthouse æ€§èƒ½æŠ¥å‘Š')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check Performance Regression
        if: always()
        run: |
          echo "æ£€æŸ¥æ€§èƒ½é€€åŒ–..."

          perf=${{ steps.format_score.outputs.perf_score }}
          a11y=${{ steps.format_score.outputs.a11y_score }}
          bp=${{ steps.format_score.outputs.bp_score }}
          seo=${{ steps.format_score.outputs.seo_score }}

          # æ€§èƒ½é˜ˆå€¼
          PERF_THRESHOLD=80
          A11Y_THRESHOLD=90
          BP_THRESHOLD=85
          SEO_THRESHOLD=90

          has_regression=false

          if [ "$perf" -lt "$PERF_THRESHOLD" ]; then
            echo "::warning::âš ï¸ æ€§èƒ½åˆ†æ•° ($perf) ä½äºé˜ˆå€¼ ($PERF_THRESHOLD)"
            has_regression=true
          fi

          if [ "$a11y" -lt "$A11Y_THRESHOLD" ]; then
            echo "::warning::âš ï¸ å¯è®¿é—®æ€§åˆ†æ•° ($a11y) ä½äºé˜ˆå€¼ ($A11Y_THRESHOLD)"
            has_regression=true
          fi

          if [ "$bp" -lt "$BP_THRESHOLD" ]; then
            echo "::warning::âš ï¸ æœ€ä½³å®è·µåˆ†æ•° ($bp) ä½äºé˜ˆå€¼ ($BP_THRESHOLD)"
            has_regression=true
          fi

          if [ "$seo" -lt "$SEO_THRESHOLD" ]; then
            echo "::warning::âš ï¸ SEO åˆ†æ•° ($seo) ä½äºé˜ˆå€¼ ($SEO_THRESHOLD)"
            has_regression=true
          fi

          if [ "$has_regression" = true ]; then
            echo "::error::æ€§èƒ½é€€åŒ–æ£€æµ‹åˆ°ï¼è¯·æ£€æŸ¥ä¸Šè¿°è­¦å‘Šå¹¶ä¼˜åŒ–æ€§èƒ½ã€‚"
            exit 1
          fi

          echo "âœ… æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡éƒ½åœ¨é˜ˆå€¼èŒƒå›´å†…ï¼"

      - name: Performance Summary
        if: always()
        run: |
          echo "ğŸ“Š Lighthouse æ€§èƒ½æ‘˜è¦"
          echo "========================"
          echo "æ€§èƒ½åˆ†æ•°: ${{ steps.format_score.outputs.perf_score }}"
          echo "å¯è®¿é—®æ€§: ${{ steps.format_score.outputs.a11y_score }}"
          echo "æœ€ä½³å®è·µ: ${{ steps.format_score.outputs.bp_score }}"
          echo "SEO: ${{ steps.format_score.outputs.seo_score }}"
          echo "========================"
