// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
include ':tauri-android'

def cargoHome = System.getenv('CARGO_HOME') ?: "${System.getProperty('user.home')}/.cargo"
def registrySrc = new File(cargoHome, 'registry/src')

def tauriVersion = null
def cargoLock = new File(settingsDir, '../../Cargo.lock')

if (cargoLock.exists()) {
  def inTauriPackage = false
  cargoLock.eachLine('UTF-8') { line ->
    if (tauriVersion != null) return

    def trimmed = line.trim()
    if (trimmed == '[[package]]') {
      inTauriPackage = false
      return
    }

    if (trimmed == 'name = \"tauri\"') {
      inTauriPackage = true
      return
    }

    if (inTauriPackage && trimmed.startsWith('version = \"')) {
      def matcher = (trimmed =~ /^version = \"([^\"]+)\"$/)
      if (matcher.matches()) {
        tauriVersion = matcher[0][1]
      }
      inTauriPackage = false
    }
  }
}

File tauriAndroidDir = null

// 优先按 Cargo.lock 锁定版本定位，避免误选其它 tauri 版本
if (tauriVersion != null && registrySrc.exists()) {
  registrySrc.eachDir { registryDir ->
    if (tauriAndroidDir != null) return
    def candidate = new File(registryDir, "tauri-${tauriVersion}/mobile/android")
    if (candidate.exists()) {
      tauriAndroidDir = candidate
    }
  }
}

// 兜底：扫描 registry 中已缓存的 tauri-* 目录
if (tauriAndroidDir == null && registrySrc.exists()) {
  registrySrc.eachDir { registryDir ->
    if (tauriAndroidDir != null) return
    registryDir.eachDirMatch(~ /^tauri-.+$/) { crateDir ->
      if (tauriAndroidDir != null) return
      def candidate = new File(crateDir, 'mobile/android')
      if (candidate.exists()) {
        tauriAndroidDir = candidate
      }
    }
  }
}

if (tauriAndroidDir == null) {
  def details = [
    "无法定位 tauri Android Gradle 工程目录。",
    "请确保已安装 Rust 依赖，并执行过 `cargo fetch` / `cargo build` 以缓存 crates。",
    "已尝试路径: ${registrySrc}",
    tauriVersion != null ? "Cargo.lock 锁定 tauri 版本: ${tauriVersion}" : "未能从 Cargo.lock 解析 tauri 版本",
  ].join('\n')
  throw new GradleException(details)
}

project(':tauri-android').projectDir = tauriAndroidDir
