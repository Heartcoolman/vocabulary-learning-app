# ç”¨æˆ·ç”»åƒæ•°æ®è¿ç§»ä½¿ç”¨æ–‡æ¡£

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨æ•°æ®è¿ç§»è„šæœ¬å’Œä¸€è‡´æ€§æ ¡éªŒå·¥å…·ï¼Œå°†æ—§è¡¨æ•°æ®è¿ç§»åˆ°æ–°çš„ UserLearningProfile è¡¨ã€‚

## ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
- [è¿ç§»è„šæœ¬](#è¿ç§»è„šæœ¬)
- [ä¸€è‡´æ€§æ ¡éªŒå·¥å…·](#ä¸€è‡´æ€§æ ¡éªŒå·¥å…·)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## æ¦‚è¿°

### ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®è¿ç§»ï¼Ÿ

ç³»ç»Ÿæ¶æ„æ¼”è¿›è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å°†åˆ†æ•£åœ¨å¤šä¸ªè¡¨ä¸­çš„ç”¨æˆ·çŠ¶æ€æ•°æ®æ•´åˆåˆ°ç»Ÿä¸€çš„ `UserLearningProfile` è¡¨ä¸­ï¼š

- **AmasUserState**: å­˜å‚¨ç”¨æˆ·çš„è®¤çŸ¥çŠ¶æ€ï¼ˆæ³¨æ„åŠ›ã€ç–²åŠ³åº¦ã€åŠ¨æœºç­‰ï¼‰
- **HabitProfile**: å­˜å‚¨ç”¨æˆ·çš„å­¦ä¹ ä¹ æƒ¯ï¼ˆæ—¶é—´åå¥½ã€èŠ‚å¥åå¥½ï¼‰
- **UserLearningProfile**: æ–°çš„ç»Ÿä¸€ç”¨æˆ·å­¦ä¹ æ¡£æ¡ˆè¡¨

### è¿ç§»ç›®æ ‡

1. å°† `AmasUserState` æ•°æ®è¿ç§»åˆ° `UserLearningProfile`
2. å°† `HabitProfile` æ•°æ®åˆå¹¶åˆ° `UserLearningProfile`
3. ç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§
4. æ”¯æŒå¢é‡è¿ç§»å’Œå›æ»š

---

## å‡†å¤‡å·¥ä½œ

### 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥

ç¡®ä¿ `.env` æ–‡ä»¶ä¸­é…ç½®äº†æ­£ç¡®çš„æ•°æ®åº“è¿æ¥ï¼š

```env
DATABASE_URL="postgresql://username:password@localhost:5432/danci_db"
```

### 2. å¤‡ä»½æ•°æ®åº“

**å¼ºçƒˆå»ºè®®åœ¨æ‰§è¡Œè¿ç§»å‰å¤‡ä»½æ•°æ®åº“ï¼**

```bash
# PostgreSQL å¤‡ä»½
pg_dump -U username -d danci_db -f backup_$(date +%Y%m%d_%H%M%S).sql

# æˆ–ä½¿ç”¨ Docker
docker exec -t postgres_container pg_dump -U username danci_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 3. ç¡®è®¤ Prisma Schema å·²æ›´æ–°

æ£€æŸ¥ `packages/backend/prisma/schema.prisma` ä¸­æ˜¯å¦å·²åŒ…å« `UserLearningProfile` è¡¨å®šä¹‰ï¼š

```prisma
model UserLearningProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  theta               Float    @default(0)
  thetaVariance       Float    @default(1)
  attention           Float    @default(0.7)
  fatigue             Float    @default(0)
  motivation          Float    @default(0.5)
  emotionBaseline     String   @default("neutral")
  lastReportedEmotion String?
  flowScore           Float    @default(0)
  flowBaseline        Float    @default(0.5)
  activePolicyVersion String   @default("v1")
  forgettingParams    Json     @default("{}")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_learning_profiles")
}
```

### 4. è¿è¡Œæ•°æ®åº“è¿ç§»

å¦‚æœè¡¨å°šæœªåˆ›å»ºï¼Œè¿è¡Œ Prisma è¿ç§»ï¼š

```bash
cd packages/backend
npm run prisma:migrate
```

---

## è¿ç§»è„šæœ¬

æä¾›ä¸¤ä¸ªè¿ç§»è„šæœ¬ï¼š

1. **migrate-user-learning-profile.ts** - åŸºç¡€ç‰ˆæœ¬ï¼Œä»…è¿ç§» AmasUserState
2. **migrate-user-profiles.ts** - å®Œæ•´ç‰ˆæœ¬ï¼Œåˆå¹¶ AmasUserState + HabitProfile

æ¨èä½¿ç”¨å®Œæ•´ç‰ˆæœ¬ `migrate-user-profiles.ts`ã€‚

### ä½¿ç”¨æµç¨‹

#### æ­¥éª¤ 1: é¢„è§ˆè¿ç§»ï¼ˆé¢„è§ˆæ¨¡å¼ï¼‰

å…ˆè¿è¡Œé¢„è§ˆæ¨¡å¼ï¼ŒæŸ¥çœ‹å°†è¦è¿ç§»çš„æ•°æ®ï¼Œ**ä¸ä¼šä¿®æ”¹æ•°æ®åº“**ï¼š

```bash
npm run migrate:user-profiles
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
================================================================================
ç”¨æˆ·ç”»åƒæ•°æ®è¿ç§»å·¥å…·ï¼ˆå®Œæ•´ç‰ˆï¼‰
AmasUserState + HabitProfile -> UserLearningProfile
================================================================================

ğŸš€ å¼€å§‹ç”¨æˆ·ç”»åƒæ•°æ®è¿ç§»

   AmasUserState + HabitProfile -> UserLearningProfile

ğŸ“‹ æ¨¡å¼: é¢„è§ˆæ¨¡å¼ï¼ˆä¸ä¿®æ”¹æ•°æ®ï¼‰

ğŸ“Š æŸ¥è¯¢ AmasUserState æ•°æ®...
   æ‰¾åˆ° 150 æ¡è®°å½•

ğŸ” éªŒè¯ç”¨æˆ·æ•°æ®...
   âœ… æœ‰æ•ˆè®°å½•: 150

ğŸ“Š æŸ¥è¯¢ HabitProfile æ•°æ®...
   æ‰¾åˆ° 120 æ¡ä¹ æƒ¯æ¡£æ¡ˆ

ğŸ“Š æŸ¥è¯¢ç°æœ‰çš„ UserLearningProfile æ•°æ®...
   æ‰¾åˆ° 50 æ¡ç°æœ‰æ¡£æ¡ˆ

ğŸ”§ æ•°æ®éªŒè¯ä¸è½¬æ¢...

âœ… å·²è½¬æ¢ 150 æ¡è®°å½•

ğŸ“‹ è½¬æ¢åçš„æ•°æ®ç¤ºä¾‹ï¼ˆå‰10æ¡ï¼‰:
----------------------------------------------------------------------------------------------------
1. userId: abc-123-def
   theta: 0.651, thetaVariance: 0.300
   attention: 0.750, fatigue: 0.200, motivation: 0.600
   emotionBaseline: neutral, flowScore: 0.690
   åŒ…å«ä¹ æƒ¯ä¿¡æ¯: æ˜¯

2. userId: xyz-456-ghi
   theta: 0.480, thetaVariance: 0.500
   attention: 0.650, fatigue: 0.350, motivation: 0.450
   emotionBaseline: calm, flowScore: 0.570
   åŒ…å«ä¹ æƒ¯ä¿¡æ¯: å¦

...

âš ï¸  é¢„è§ˆæ¨¡å¼ï¼šæœªä¿®æ”¹ä»»ä½•æ•°æ®
ğŸ’¡ å¦‚éœ€æ‰§è¡Œè¿ç§»ï¼Œè¯·ä½¿ç”¨: npm run migrate:user-profiles -- --execute
```

#### æ­¥éª¤ 2: æ‰§è¡Œè¿ç§»

ç¡®è®¤æ— è¯¯åï¼Œæ‰§è¡Œå®é™…è¿ç§»ï¼š

```bash
npm run migrate:user-profiles:execute
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
ğŸ“¦ å¤‡ä»½ç°æœ‰çš„ UserLearningProfile æ•°æ®...
âœ… å·²å¤‡ä»½ 50 æ¡è®°å½•

ğŸ”§ å¼€å§‹æ‰§è¡Œè¿ç§»...

   å¤„ç†æ‰¹æ¬¡ 1/3...
   å¤„ç†æ‰¹æ¬¡ 2/3...
   å¤„ç†æ‰¹æ¬¡ 3/3...

ğŸ” æ‰§è¡ŒåŒå†™éªŒè¯...

   âœ… ç”¨æˆ· abc-123-def åŒå†™éªŒè¯é€šè¿‡
   âœ… ç”¨æˆ· xyz-456-ghi åŒå†™éªŒè¯é€šè¿‡
   ...

ğŸ“Š åŒå†™éªŒè¯ç»“æœ: 20/20 é€šè¿‡

================================================================================
ğŸ“Š è¿ç§»ç»Ÿè®¡:
   - æ€»è®°å½•æ•°: 150
   - æˆåŠŸ: 150
   - å¤±è´¥: 0
   - è·³è¿‡: 0

ğŸ” éªŒè¯è¿ç§»ç»“æœ...

ğŸ“Š æ•°æ®ç»Ÿè®¡:
   - AmasUserState è®°å½•æ•°: 150
   - HabitProfile è®°å½•æ•°: 120
   - UserLearningProfile è®°å½•æ•°: 150
   - User æ€»æ•°: 200

ğŸ“ˆ è¦†ç›–ç‡åˆ†æ:
   - æœ‰ AmasUserState çš„ç”¨æˆ·: 150
   - æœ‰ UserLearningProfile çš„ç”¨æˆ·: 150
   - ç¼ºå°‘ UserLearningProfile çš„ç”¨æˆ·: 0
   - å¤šä½™çš„ UserLearningProfile: 0

ğŸ”¬ ä¹ æƒ¯ä¿¡æ¯åˆå¹¶æ£€æŸ¥ï¼ˆæŠ½æ ·10æ¡ï¼‰...
   âœ… ç”¨æˆ· abc-123-def ä¹ æƒ¯ä¿¡æ¯å·²åˆå¹¶
   âœ… ç”¨æˆ· xyz-456-ghi ä¹ æƒ¯ä¿¡æ¯å·²åˆå¹¶
   ...

ğŸ“Š ä¹ æƒ¯ä¿¡æ¯åˆå¹¶ç‡: 80.0%

ğŸ”¬ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆæŠ½æ ·10æ¡ï¼‰...
   âœ… ç”¨æˆ· abc-123-def æ•°æ®ä¸€è‡´
   âœ… ç”¨æˆ· xyz-456-ghi æ•°æ®ä¸€è‡´
   ...

ğŸ“‹ éªŒè¯æ€»ç»“:
   - è¿ç§»è¦†ç›–ç‡: 100.0%
   - æ•°æ®ä¸€è‡´æ€§: 100.0%
   ğŸ‰ è¿ç§»å®Œæˆåº¦: ä¼˜ç§€

================================================================================
âœ… å®Œæˆï¼
================================================================================
```

#### æ­¥éª¤ 3: éªŒè¯è¿ç§»ç»“æœ

å•ç‹¬è¿è¡ŒéªŒè¯å·¥å…·ï¼š

```bash
npm run migrate:user-profiles:verify
```

#### æ­¥éª¤ 4: å›æ»šï¼ˆå¦‚éœ€ï¼‰

å¦‚æœå‘ç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°è¿ç§»å‰çš„çŠ¶æ€ï¼ˆ**ä»…åœ¨åŒä¸€ä¼šè¯ä¸­æœ‰æ•ˆ**ï¼‰ï¼š

```bash
npm run migrate:user-profiles:rollback
```

**æ³¨æ„ï¼š** å›æ»šåŠŸèƒ½ä¾èµ–äºå†…å­˜ä¸­çš„å¤‡ä»½æ•°æ®ï¼Œåªèƒ½åœ¨æ‰§è¡Œè¿ç§»åç«‹å³å›æ»šã€‚å¦‚æœä¼šè¯ç»“æŸï¼Œéœ€è¦ä»æ•°æ®åº“å¤‡ä»½æ¢å¤ã€‚

---

## ä¸€è‡´æ€§æ ¡éªŒå·¥å…·

ç‹¬ç«‹çš„æ•°æ®ä¸€è‡´æ€§æ ¡éªŒå·¥å…·ï¼Œç”¨äºæ£€æŸ¥æ•°æ®è´¨é‡å’Œä¸€è‡´æ€§ã€‚

### åŸºæœ¬ä½¿ç”¨

```bash
# é»˜è®¤æ£€æŸ¥ 100 ä¸ªæ ·æœ¬
npm run verify:profile-consistency

# è‡ªå®šä¹‰æ ·æœ¬å¤§å°
npm run verify:profile-consistency -- --sample=200

# å¯¼å‡ºè¯¦ç»†æŠ¥å‘Šåˆ° JSON æ–‡ä»¶
npm run verify:profile-consistency:export
```

### è¾“å‡ºç¤ºä¾‹

```
================================================================================
ç”¨æˆ·ç”»åƒæ•°æ®ä¸€è‡´æ€§æ ¡éªŒå·¥å…·
================================================================================

ğŸ” å¼€å§‹ä¸€è‡´æ€§æ ¡éªŒ...

ğŸ“Š ç»Ÿè®¡æ•°æ®...
   - æ€»ç”¨æˆ·æ•°: 200
   - AmasUserState: 150
   - HabitProfile: 120
   - UserLearningProfile: 150

ğŸ“ˆ æ£€æŸ¥è¦†ç›–ç‡...
   - ç¼ºå°‘ UserLearningProfile çš„ç”¨æˆ·: 0
   - å­¤ç«‹çš„ UserLearningProfile: 0

ğŸ”¬ æŠ½æ ·æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ï¼ˆæ ·æœ¬é‡: 100ï¼‰...

   å¤„ç†å®Œæˆ: 100/100

================================================================================
ğŸ“‹ ä¸€è‡´æ€§æ ¡éªŒæŠ¥å‘Š
================================================================================

ğŸ“Š æ€»ä½“ç»Ÿè®¡:
   - æ£€æŸ¥ç”¨æˆ·æ•°: 100
   - ä¸€è‡´çš„ç”¨æˆ·: 95
   - ä¸ä¸€è‡´çš„ç”¨æˆ·: 5
   - ç¼ºå°‘æ¡£æ¡ˆ: 0
   - æ•°æ®é”™è¯¯: 2

   ä¸€è‡´æ€§ç‡: 95.0%

âš ï¸  é—®é¢˜ç»Ÿè®¡ï¼ˆæŒ‰ç±»å‹ï¼‰:
   âš ï¸ DATA_MISMATCH: 3
   âš ï¸ MISSING_MERGE: 2
   â„¹ï¸ MISSING_FIELD: 1

âŒ é—®é¢˜è¯¦æƒ…ï¼ˆå‰20æ¡ï¼‰:
--------------------------------------------------------------------------------
1. âš ï¸ [WARNING] DATA_MISMATCH
   ç”¨æˆ·: user-123-abc
   æè¿°: attention å­—æ®µä¸ä¸€è‡´
   è¯¦æƒ…: {
     "field": "attention",
     "amasValue": 0.75,
     "learningProfileValue": 0.73,
     "difference": 0.02
   }

2. â„¹ï¸ [INFO] MISSING_MERGE
   ç”¨æˆ·: user-456-def
   æè¿°: æœ‰ HabitProfile ä½† UserLearningProfile æœªåˆå¹¶ä¹ æƒ¯ä¿¡æ¯

...

ğŸ’¡ ä¿®å¤å»ºè®®:
   1. å‘ç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œå»ºè®®é‡æ–°è¿è¡Œè¿ç§»ä»¥åŒæ­¥æœ€æ–°æ•°æ®
   2. éƒ¨åˆ†ä¹ æƒ¯ä¿¡æ¯æœªåˆå¹¶åˆ° UserLearningProfileï¼Œé‡æ–°è¿è¡Œè¿ç§»ä»¥åˆå¹¶æ•°æ®

ğŸ¥ æ•°æ®å¥åº·åº¦:
   âœ… è‰¯å¥½ - æ•°æ®è´¨é‡è¾ƒå¥½ï¼Œæœ‰å°‘é‡é—®é¢˜

================================================================================
âœ… æ ¡éªŒå®Œæˆï¼
================================================================================
```

### å¯¼å‡ºçš„ JSON æŠ¥å‘Šæ ¼å¼

```json
{
  "timestamp": "2025-12-12T10:30:00.000Z",
  "summary": {
    "totalUsers": 100,
    "consistentUsers": 95,
    "inconsistentUsers": 5,
    "missingProfiles": 0,
    "dataErrors": 2
  },
  "consistencyRate": 95.0,
  "issues": [
    {
      "userId": "user-123-abc",
      "severity": "warning",
      "type": "DATA_MISMATCH",
      "description": "attention å­—æ®µä¸ä¸€è‡´",
      "details": {
        "field": "attention",
        "amasValue": 0.75,
        "learningProfileValue": 0.73,
        "difference": 0.02
      }
    }
  ],
  "recommendations": ["å‘ç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œå»ºè®®é‡æ–°è¿è¡Œè¿ç§»ä»¥åŒæ­¥æœ€æ–°æ•°æ®"]
}
```

---

## æœ€ä½³å®è·µ

### 1. è¿ç§»å‰

- âœ… å¤‡ä»½æ•°æ®åº“
- âœ… åœ¨æµ‹è¯•ç¯å¢ƒå…ˆè¿è¡Œ
- âœ… ä½¿ç”¨é¢„è§ˆæ¨¡å¼æŸ¥çœ‹æ•°æ®
- âœ… æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆå¤‡ä»½éœ€è¦é¢å¤–ç©ºé—´ï¼‰

### 2. è¿ç§»ä¸­

- âœ… é¿å…å¹¶å‘æ“ä½œï¼ˆä¸è¦åŒæ—¶è¿è¡Œå¤šæ¬¡è¿ç§»ï¼‰
- âœ… è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼Œå…³æ³¨é”™è¯¯ä¿¡æ¯
- âœ… ä¿æŒæ•°æ®åº“è¿æ¥ç¨³å®š

### 3. è¿ç§»å

- âœ… è¿è¡ŒéªŒè¯è„šæœ¬ç¡®è®¤ç»“æœ
- âœ… è¿è¡Œä¸€è‡´æ€§æ ¡éªŒå·¥å…·
- âœ… æŠ½æŸ¥éƒ¨åˆ†ç”¨æˆ·æ•°æ®
- âœ… ä¿ç•™æ•°æ®åº“å¤‡ä»½è‡³å°‘ä¸€å‘¨

### 4. å¢é‡è¿ç§»

è„šæœ¬æ”¯æŒå¢é‡è¿ç§»ï¼Œå¦‚æœæœ‰æ–°ç”¨æˆ·æˆ–æ•°æ®æ›´æ–°ï¼š

```bash
# ç›´æ¥é‡æ–°è¿è¡Œæ‰§è¡Œå‘½ä»¤å³å¯
npm run migrate:user-profiles:execute
```

è„šæœ¬ä¼šï¼š

- è‡ªåŠ¨è·³è¿‡å·²è¿ç§»çš„ç”¨æˆ·ï¼ˆä½¿ç”¨ upsertï¼‰
- æ›´æ–°å‘ç”Ÿå˜åŒ–çš„æ•°æ®
- æ’å…¥æ–°ç”¨æˆ·çš„æ•°æ®

---

## å¸¸è§é—®é¢˜

### Q1: è¿ç§»ä¼šå½±å“ç°æœ‰æ•°æ®å—ï¼Ÿ

**A:** ä¸ä¼šã€‚è¿ç§»è„šæœ¬ï¼š

- ä½¿ç”¨ `upsert` æ“ä½œï¼Œä¸ä¼šåˆ é™¤ç°æœ‰æ•°æ®
- åªæ›´æ–°æŒ‡å®šå­—æ®µï¼Œä¿ç•™ `lastReportedEmotion` å’Œ `activePolicyVersion` ç­‰å­—æ®µ
- æ‰§è¡Œå‰ä¼šè‡ªåŠ¨å¤‡ä»½ç°æœ‰æ•°æ®

### Q2: å¯ä»¥é‡å¤è¿è¡Œè¿ç§»è„šæœ¬å—ï¼Ÿ

**A:** å¯ä»¥ã€‚è„šæœ¬æ”¯æŒå¢é‡è¿ç§»ï¼Œé‡å¤è¿è¡Œæ˜¯å®‰å…¨çš„ï¼š

- å·²å­˜åœ¨çš„è®°å½•ä¼šè¢«æ›´æ–°
- æ–°è®°å½•ä¼šè¢«æ’å…¥
- ä¸ä¼šé‡å¤æ’å…¥æ•°æ®

### Q3: HabitProfile æ•°æ®å¦‚ä½•åˆå¹¶ï¼Ÿ

**A:** HabitProfile æ•°æ®ä¼šè¢«åˆå¹¶åˆ° `forgettingParams` å­—æ®µä¸­ï¼š

```json
{
  "cognitive": {
    "mem": 0.6,
    "speed": 0.7,
    "stability": 0.65
  },
  "habits": {
    "timePreference": {
      "preferredTimes": [0, 0, ..., 0.8, 0.9, ...]
    },
    "rhythmPreference": {
      "sessionMedianMinutes": 25,
      "batchMedian": 15
    }
  }
}
```

### Q4: è¿ç§»å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ

**A:** æ ¹æ®å¤±è´¥åŸå› ï¼š

1. **æ•°æ®éªŒè¯å¤±è´¥**: æ£€æŸ¥æºæ•°æ®ï¼Œä¿®å¤åé‡æ–°è¿è¡Œ
2. **æ•°æ®åº“è¿æ¥å¤±è´¥**: æ£€æŸ¥ç½‘ç»œå’Œæ•°æ®åº“çŠ¶æ€
3. **æ‰¹æ¬¡å¤±è´¥**: å•ä¸ªæ‰¹æ¬¡å¤±è´¥ä¸å½±å“å…¶ä»–æ‰¹æ¬¡ï¼Œä¿®å¤åé‡æ–°è¿è¡Œ
4. **ä¸¥é‡é”™è¯¯**: ä»æ•°æ®åº“å¤‡ä»½æ¢å¤

### Q5: å¦‚ä½•éªŒè¯è¿ç§»æ˜¯å¦æˆåŠŸï¼Ÿ

**A:** ä¸‰æ­¥éªŒè¯ï¼š

```bash
# 1. è¿è¡Œè¿ç§»éªŒè¯
npm run migrate:user-profiles:verify

# 2. è¿è¡Œä¸€è‡´æ€§æ ¡éªŒ
npm run verify:profile-consistency

# 3. æ‰‹åŠ¨æŠ½æŸ¥
# åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ ä¸ªç”¨æˆ·ï¼Œå¯¹æ¯”æºè¡¨å’Œç›®æ ‡è¡¨
```

### Q6: è¿ç§»éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

**A:** å–å†³äºæ•°æ®é‡ï¼š

- 100 ä¸ªç”¨æˆ·: ~5-10 ç§’
- 1,000 ä¸ªç”¨æˆ·: ~30-60 ç§’
- 10,000 ä¸ªç”¨æˆ·: ~5-10 åˆ†é’Ÿ

æ‰¹å¤„ç†å¤§å°ä¸º 50ï¼Œå¯åœ¨è„šæœ¬ä¸­è°ƒæ•´ã€‚

---

## æ•…éšœæ’é™¤

### é—®é¢˜ 1: è¡¨ä¸å­˜åœ¨é”™è¯¯

```
âŒ UserLearningProfile è¡¨ä¸å­˜åœ¨
```

**è§£å†³æ–¹æ¡ˆï¼š**

```bash
npm run prisma:migrate
```

### é—®é¢˜ 2: æ•°æ®éªŒè¯å¤±è´¥

```
âš ï¸  ç”¨æˆ· xxx æ•°æ®éªŒè¯å¤±è´¥: attention out of range: 1.5
```

**è§£å†³æ–¹æ¡ˆï¼š**

æ£€æŸ¥å¹¶ä¿®å¤ AmasUserState ä¸­çš„å¼‚å¸¸æ•°æ®ï¼š

```sql
-- æŸ¥æ‰¾å¼‚å¸¸æ•°æ®
SELECT * FROM amas_user_states
WHERE attention < 0 OR attention > 1
   OR fatigue < 0 OR fatigue > 1
   OR motivation < -1 OR motivation > 1;

-- ä¿®å¤å¼‚å¸¸æ•°æ®ï¼ˆæ ¹æ®å®é™…æƒ…å†µï¼‰
UPDATE amas_user_states
SET attention = 0.7
WHERE attention > 1 OR attention < 0;
```

### é—®é¢˜ 3: æ•°æ®ä¸€è‡´æ€§é—®é¢˜

```
âš ï¸  ç”¨æˆ· xxx æ•°æ®ä¸ä¸€è‡´: attention: 0.75 -> 0.73
```

**è§£å†³æ–¹æ¡ˆï¼š**

å°çš„æµ®ç‚¹æ•°å·®å¼‚ï¼ˆ< 0.01ï¼‰æ˜¯æ­£å¸¸çš„ã€‚å¦‚æœå·®å¼‚è¾ƒå¤§ï¼š

1. æ£€æŸ¥æ˜¯å¦æœ‰å¹¶å‘æ›´æ–°
2. é‡æ–°è¿è¡Œè¿ç§»ä»¥åŒæ­¥æœ€æ–°æ•°æ®ï¼š
   ```bash
   npm run migrate:user-profiles:execute
   ```

### é—®é¢˜ 4: ä¹ æƒ¯ä¿¡æ¯æœªåˆå¹¶

```
â„¹ï¸ [INFO] MISSING_MERGE
æœ‰ HabitProfile ä½† UserLearningProfile æœªåˆå¹¶ä¹ æƒ¯ä¿¡æ¯
```

**è§£å†³æ–¹æ¡ˆï¼š**

é‡æ–°è¿è¡Œè¿ç§»è„šæœ¬ä¼šè‡ªåŠ¨åˆå¹¶ä¹ æƒ¯ä¿¡æ¯ï¼š

```bash
npm run migrate:user-profiles:execute
```

### é—®é¢˜ 5: æ‰¹æ¬¡è¿ç§»å¤±è´¥

```
âŒ æ‰¹æ¬¡è¿ç§»å¤±è´¥: Error: ...
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. æ£€æŸ¥é”™è¯¯æ—¥å¿—ï¼Œå®šä½å…·ä½“åŸå› 
2. ä¿®å¤é—®é¢˜åé‡æ–°è¿è¡Œ
3. è„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡å·²æˆåŠŸçš„è®°å½•

### é—®é¢˜ 6: å›æ»šå¤±è´¥

```
âš ï¸  æ²¡æœ‰å¤‡ä»½æ•°æ®ï¼Œæ— æ³•å›æ»š
```

**è§£å†³æ–¹æ¡ˆï¼š**

å›æ»šåŠŸèƒ½ä»…åœ¨åŒä¸€ä¼šè¯ä¸­æœ‰æ•ˆã€‚å¦‚æœéœ€è¦å›æ»šï¼š

1. ä»æ•°æ®åº“å¤‡ä»½æ¢å¤ï¼š

   ```bash
   psql -U username -d danci_db < backup_file.sql
   ```

2. æˆ–æ‰‹åŠ¨åˆ é™¤è¿ç§»çš„æ•°æ®ï¼š
   ```sql
   DELETE FROM user_learning_profiles
   WHERE created_at > '2025-12-12 10:00:00';
   ```

---

## CLI å‘½ä»¤å‚è€ƒ

### è¿ç§»è„šæœ¬

| å‘½ä»¤                                     | è¯´æ˜                   |
| ---------------------------------------- | ---------------------- |
| `npm run migrate:user-profiles`          | é¢„è§ˆæ¨¡å¼ï¼ˆä¸ä¿®æ”¹æ•°æ®ï¼‰ |
| `npm run migrate:user-profiles:execute`  | æ‰§è¡Œè¿ç§»               |
| `npm run migrate:user-profiles:verify`   | ä»…éªŒè¯è¿ç§»ç»“æœ         |
| `npm run migrate:user-profiles:rollback` | å›æ»šè¿ç§»ï¼ˆä»…åŒä¸€ä¼šè¯ï¼‰ |

### ä¸€è‡´æ€§æ ¡éªŒ

| å‘½ä»¤                                                 | è¯´æ˜                            |
| ---------------------------------------------------- | ------------------------------- |
| `npm run verify:profile-consistency`                 | è¿è¡Œä¸€è‡´æ€§æ ¡éªŒï¼ˆé»˜è®¤ 100 æ ·æœ¬ï¼‰ |
| `npm run verify:profile-consistency -- --sample=200` | è‡ªå®šä¹‰æ ·æœ¬å¤§å°                  |
| `npm run verify:profile-consistency:export`          | å¯¼å‡ºè¯¦ç»†æŠ¥å‘Šåˆ° JSON             |

---

## æ•°æ®æ˜ å°„å…³ç³»

### AmasUserState â†’ UserLearningProfile

| æºå­—æ®µ                                   | ç›®æ ‡å­—æ®µ                     | è½¬æ¢é€»è¾‘                                |
| ---------------------------------------- | ---------------------------- | --------------------------------------- |
| `userId`                                 | `userId`                     | ç›´æ¥æ˜ å°„                                |
| `attention`                              | `attention`                  | ç›´æ¥æ˜ å°„                                |
| `fatigue`                                | `fatigue`                    | ç›´æ¥æ˜ å°„                                |
| `motivation`                             | `motivation`                 | ç›´æ¥æ˜ å°„                                |
| `cognitiveProfile.{mem,speed,stability}` | `theta`                      | å¹³å‡å€¼: (mem + speed + stability) / 3   |
| `confidence`                             | `thetaVariance`              | åå‘: 1 - confidence                    |
| `trendState.emotion`                     | `emotionBaseline`            | JSON è§£ææå–                           |
| `attention + motivation`                 | `flowScore`                  | attention _ 0.6 + abs(motivation) _ 0.4 |
| -                                        | `flowBaseline`               | é»˜è®¤: 0.5                               |
| -                                        | `activePolicyVersion`        | é»˜è®¤: 'v1'                              |
| `cognitiveProfile`                       | `forgettingParams.cognitive` | JSON åºåˆ—åŒ–                             |

### HabitProfile â†’ UserLearningProfile

| æºå­—æ®µ       | ç›®æ ‡å­—æ®µ                                   | è½¬æ¢é€»è¾‘  |
| ------------ | ------------------------------------------ | --------- |
| `timePref`   | `forgettingParams.habits.timePreference`   | JSON åˆå¹¶ |
| `rhythmPref` | `forgettingParams.habits.rhythmPreference` | JSON åˆå¹¶ |

---

## æŠ€æœ¯ç»†èŠ‚

### æ‰¹å¤„ç†é…ç½®

```typescript
const CONFIG = {
  batchSize: 50, // æ¯æ‰¹å¤„ç† 50 æ¡è®°å½•
  maxRetries: 3, // æœ€å¤§é‡è¯•æ¬¡æ•°
  enableDoubleWrite: true, // å¯ç”¨åŒå†™éªŒè¯
  incrementalMode: true, // å¢é‡è¿ç§»æ¨¡å¼
};
```

### æ•°æ®éªŒè¯è§„åˆ™

- `attention`: [0, 1]
- `fatigue`: [0, 1]
- `motivation`: [-1, 1]
- `theta`: [-3, 3] (IRT èƒ½åŠ›å‚æ•°)
- `thetaVariance`: [0.1, 2]
- `flowScore`: [0, 1]
- `flowBaseline`: [0, 1]

### æ€§èƒ½æŒ‡æ ‡

- **å¤„ç†é€Ÿåº¦**: çº¦ 50-100 æ¡/ç§’
- **å†…å­˜å ç”¨**: ä½ï¼ˆæ‰¹é‡å¤„ç†ï¼‰
- **äº‹åŠ¡æ—¶é•¿**: æ¯æ‰¹çº¦ 0.5-2 ç§’

---

## ç›¸å…³æ–‡æ¡£

- [Prisma Schema](../prisma/schema.prisma)
- [UserLearningProfile Model](../prisma/schema.prisma#L870-L890)
- [AmasUserState Model](../prisma/schema.prisma#L269-L287)
- [HabitProfile Model](../prisma/schema.prisma#L340-L349)

---

## ç»´æŠ¤è®°å½•

| æ—¥æœŸ       | ç‰ˆæœ¬  | è¯´æ˜                                   |
| ---------- | ----- | -------------------------------------- |
| 2025-12-12 | 2.0.0 | å®Œæ•´ç‰ˆè¿ç§»è„šæœ¬ï¼Œæ”¯æŒ HabitProfile åˆå¹¶ |
| 2025-12-12 | 1.0.0 | åŸºç¡€è¿ç§»è„šæœ¬                           |

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤ Issueã€‚
