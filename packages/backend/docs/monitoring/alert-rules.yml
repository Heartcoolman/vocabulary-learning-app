# Prometheus 告警规则配置
# 用于单词学习平台后端服务监控告警

groups:
  # ============================================
  # 应用层告警规则
  # ============================================
  - name: danci_backend_alerts
    interval: 30s
    rules:
      # 高错误率告警
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="danci-backend", status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="danci-backend"}[5m]))
          ) > 0.01
        for: 5m
        labels:
          severity: critical
          component: backend
          team: backend-dev
        annotations:
          summary: '后端服务高错误率'
          description: '5xx 错误率超过 1%，当前值: {{ $value | humanizePercentage }}'
          dashboard: 'https://grafana.example.com/d/backend/danci-backend'

      # 慢响应时间告警
      - alert: SlowResponseTime
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="danci-backend"}[5m])) by (le)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          component: backend
          team: backend-dev
        annotations:
          summary: 'API 响应时间过慢'
          description: '95分位响应时间超过 500ms，当前值: {{ $value | humanizeDuration }}'

      # 极慢响应时间（紧急）
      - alert: VerySlowResponseTime
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="danci-backend"}[5m])) by (le)
          ) > 2
        for: 2m
        labels:
          severity: critical
          component: backend
          team: backend-dev
        annotations:
          summary: 'API 响应时间严重过慢'
          description: '95分位响应时间超过 2秒，当前值: {{ $value | humanizeDuration }}'

      # 服务不可用
      - alert: ServiceDown
        expr: up{job="danci-backend"} == 0
        for: 1m
        labels:
          severity: critical
          component: backend
          team: backend-dev
        annotations:
          summary: '后端服务不可用'
          description: '后端服务 {{ $labels.instance }} 已停止响应'

      # QPS 异常下降
      - alert: QPSDrop
        expr: |
          (
            sum(rate(http_requests_total{job="danci-backend"}[5m]))
            <
            sum(rate(http_requests_total{job="danci-backend"}[5m] offset 1h)) * 0.5
          )
          and
          sum(rate(http_requests_total{job="danci-backend"}[5m] offset 1h)) > 10
        for: 10m
        labels:
          severity: warning
          component: backend
          team: backend-dev
        annotations:
          summary: 'QPS 异常下降'
          description: '当前 QPS 低于 1 小时前的 50%，可能存在问题'

  # ============================================
  # 系统资源告警规则
  # ============================================
  - name: system_alerts
    interval: 30s
    rules:
      # CPU 使用率过高
      - alert: HighCPUUsage
        expr: |
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 5m
        labels:
          severity: warning
          component: system
          team: ops
        annotations:
          summary: 'CPU 使用率过高'
          description: '{{ $labels.instance }} CPU 使用率超过 85%，当前值: {{ $value | humanize }}%'

      # CPU 使用率严重过高
      - alert: CriticalCPUUsage
        expr: |
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          component: system
          team: ops
        annotations:
          summary: 'CPU 使用率严重过高'
          description: '{{ $labels.instance }} CPU 使用率超过 95%，当前值: {{ $value | humanize }}%'

      # 内存使用率过高
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          component: system
          team: ops
        annotations:
          summary: '内存使用率过高'
          description: '{{ $labels.instance }} 内存使用率超过 85%，当前值: {{ $value | humanize }}%'

      # 内存使用率严重过高
      - alert: CriticalMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
          component: system
          team: ops
        annotations:
          summary: '内存使用率严重过高'
          description: '{{ $labels.instance }} 内存使用率超过 95%，当前值: {{ $value | humanize }}%'

      # 磁盘空间不足
      - alert: DiskSpaceLow
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 85
        for: 5m
        labels:
          severity: warning
          component: system
          team: ops
        annotations:
          summary: '磁盘空间不足'
          description: '{{ $labels.instance }} 磁盘使用率超过 85%，当前值: {{ $value | humanize }}%'

      # 磁盘空间严重不足
      - alert: CriticalDiskSpace
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 95
        for: 2m
        labels:
          severity: critical
          component: system
          team: ops
        annotations:
          summary: '磁盘空间严重不足'
          description: '{{ $labels.instance }} 磁盘使用率超过 95%，当前值: {{ $value | humanize }}%'

      # 磁盘 I/O 过高
      - alert: HighDiskIO
        expr: |
          rate(node_disk_io_time_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          component: system
          team: ops
        annotations:
          summary: '磁盘 I/O 负载过高'
          description: '{{ $labels.instance }} 磁盘 I/O 时间占比: {{ $value | humanizePercentage }}'

      # 系统负载过高
      - alert: HighSystemLoad
        expr: |
          node_load15 / count(node_cpu_seconds_total{mode="idle"}) without (cpu, mode) > 2
        for: 10m
        labels:
          severity: warning
          component: system
          team: ops
        annotations:
          summary: '系统负载过高'
          description: '{{ $labels.instance }} 15分钟平均负载是 CPU 核心数的 2 倍以上'

  # ============================================
  # PostgreSQL 告警规则
  # ============================================
  - name: postgres_alerts
    interval: 30s
    rules:
      # PostgreSQL 服务不可用
      - alert: PostgresDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          component: database
          team: dba
        annotations:
          summary: 'PostgreSQL 服务不可用'
          description: 'PostgreSQL 实例 {{ $labels.instance }} 无法连接'

      # 数据库连接数过多
      - alert: TooManyDatabaseConnections
        expr: |
          sum(pg_stat_activity_count) by (instance) > 100
        for: 5m
        labels:
          severity: warning
          component: database
          team: dba
        annotations:
          summary: '数据库连接数过多'
          description: '{{ $labels.instance }} 当前活跃连接数: {{ $value }}'

      # 数据库连接数接近上限
      - alert: DatabaseConnectionsNearLimit
        expr: |
          sum(pg_stat_activity_count) by (instance)
          /
          pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: critical
          component: database
          team: dba
        annotations:
          summary: '数据库连接数接近上限'
          description: '{{ $labels.instance }} 连接数已达到最大值的 80%'

      # 慢查询过多
      - alert: TooManySlowQueries
        expr: |
          rate(pg_stat_statements_mean_time_seconds{query!~"^(BEGIN|COMMIT|ROLLBACK)"}[5m]) > 1
        for: 10m
        labels:
          severity: warning
          component: database
          team: dba
        annotations:
          summary: '慢查询过多'
          description: '平均查询时间超过 1 秒'

      # 复制延迟过高（主从复制）
      - alert: PostgresReplicationLag
        expr: |
          pg_replication_lag > 10
        for: 5m
        labels:
          severity: critical
          component: database
          team: dba
        annotations:
          summary: 'PostgreSQL 复制延迟过高'
          description: '从库 {{ $labels.instance }} 复制延迟: {{ $value }} 秒'

      # 死元组过多
      - alert: TooManyDeadTuples
        expr: |
          (pg_stat_user_tables_n_dead_tup / (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup)) > 0.1
        for: 30m
        labels:
          severity: warning
          component: database
          team: dba
        annotations:
          summary: '表中死元组过多'
          description: '表 {{ $labels.relname }} 死元组占比: {{ $value | humanizePercentage }}'

      # 事务时间过长
      - alert: LongRunningTransaction
        expr: |
          max(pg_stat_activity_max_tx_duration) by (instance) > 3600
        for: 5m
        labels:
          severity: warning
          component: database
          team: dba
        annotations:
          summary: '长时间运行的事务'
          description: '{{ $labels.instance }} 存在运行超过 1 小时的事务'

  # ============================================
  # Redis 告警规则
  # ============================================
  - name: redis_alerts
    interval: 30s
    rules:
      # Redis 服务不可用
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          component: cache
          team: ops
        annotations:
          summary: 'Redis 服务不可用'
          description: 'Redis 实例 {{ $labels.instance }} 无法连接'

      # Redis 内存使用率过高
      - alert: RedisHighMemoryUsage
        expr: |
          (redis_memory_used_bytes / redis_memory_max_bytes) * 100 > 90
        for: 5m
        labels:
          severity: warning
          component: cache
          team: ops
        annotations:
          summary: 'Redis 内存使用率过高'
          description: '{{ $labels.instance }} 内存使用率: {{ $value | humanize }}%'

      # Redis 连接数过多
      - alert: TooManyRedisConnections
        expr: |
          redis_connected_clients > 500
        for: 5m
        labels:
          severity: warning
          component: cache
          team: ops
        annotations:
          summary: 'Redis 连接数过多'
          description: '{{ $labels.instance }} 当前连接数: {{ $value }}'

      # Redis 键过期速率异常
      - alert: RedisHighEvictionRate
        expr: |
          rate(redis_evicted_keys_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          component: cache
          team: ops
        annotations:
          summary: 'Redis 键淘汰速率过高'
          description: '{{ $labels.instance }} 每秒淘汰键数: {{ $value | humanize }}'

      # Redis 主从复制断开
      - alert: RedisReplicationBroken
        expr: |
          redis_connected_slaves < 1
        for: 2m
        labels:
          severity: critical
          component: cache
          team: ops
        annotations:
          summary: 'Redis 主从复制断开'
          description: 'Redis 主节点 {{ $labels.instance }} 没有从节点连接'

      # Redis 持久化失败
      - alert: RedisPersistenceError
        expr: |
          redis_rdb_last_save_timestamp_seconds < (time() - 7200)
        for: 5m
        labels:
          severity: warning
          component: cache
          team: ops
        annotations:
          summary: 'Redis 持久化可能失败'
          description: '{{ $labels.instance }} 超过 2 小时未成功保存 RDB'

  # ============================================
  # 业务指标告警规则
  # ============================================
  - name: business_alerts
    interval: 60s
    rules:
      # 用户登录失败率过高
      - alert: HighLoginFailureRate
        expr: |
          (
            sum(rate(auth_login_total{status="failure"}[10m]))
            /
            sum(rate(auth_login_total[10m]))
          ) > 0.2
        for: 10m
        labels:
          severity: warning
          component: business
          team: backend-dev
        annotations:
          summary: '用户登录失败率过高'
          description: '登录失败率: {{ $value | humanizePercentage }}'

      # 学习会话异常终止率过高
      - alert: HighSessionAbnormalTermination
        expr: |
          (
            sum(rate(learning_session_total{status="error"}[10m]))
            /
            sum(rate(learning_session_total[10m]))
          ) > 0.1
        for: 10m
        labels:
          severity: warning
          component: business
          team: backend-dev
        annotations:
          summary: '学习会话异常终止率过高'
          description: '异常终止率: {{ $value | humanizePercentage }}'

      # 单词查询失败率过高
      - alert: HighWordQueryFailureRate
        expr: |
          (
            sum(rate(word_query_total{status="error"}[10m]))
            /
            sum(rate(word_query_total[10m]))
          ) > 0.05
        for: 10m
        labels:
          severity: warning
          component: business
          team: backend-dev
        annotations:
          summary: '单词查询失败率过高'
          description: '查询失败率: {{ $value | humanizePercentage }}'

  # ============================================
  # 安全告警规则
  # ============================================
  - name: security_alerts
    interval: 60s
    rules:
      # 异常高频请求（可能是攻击）
      - alert: PossibleDDoSAttack
        expr: |
          sum(rate(http_requests_total{job="danci-backend"}[1m])) > 1000
        for: 2m
        labels:
          severity: critical
          component: security
          team: security
        annotations:
          summary: '检测到异常高频请求'
          description: '每秒请求数: {{ $value | humanize }}'

      # 大量认证失败（可能是暴力破解）
      - alert: PossibleBruteForceAttack
        expr: |
          sum(rate(auth_login_total{status="failure"}[5m])) > 50
        for: 5m
        labels:
          severity: critical
          component: security
          team: security
        annotations:
          summary: '检测到大量登录失败'
          description: '每秒失败次数: {{ $value | humanize }}'
